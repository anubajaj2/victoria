sap.ui.define(["victoria/controller/BaseController","sap/ui/model/json/JSONModel","sap/ui/core/routing/History","victoria/models/formatter","sap/m/MessageToast","sap/ui/model/Filter"],function(e,t,i,o,a,n){"use strict";return e.extend("victoria.controller.City",{formatter:o,onInit:function(){var e=this;var i=this.getModel("local").getProperty("/CurrentUser");var o=this.getModel("local").oData.AppUsers[i].UserName;o="Hey "+o;this.getView().byId("idUser").setText(o);this.resourceBundle=this.getOwnerComponent().getModel("i18n").getResourceBundle();var a,n=new t({cityCode:"",cityName:"",state:""});this.setModel(n,"cityModel");var r=new t({buttonText:"Save",deleteEnabled:false});this.setModel(r,"viewModel");var s=this.getRouter();s.getRoute("City").attachMatched(this._onRouteMatched,this)},onPressCityDownload:function(){var e="City";window.open("/cityDownload?type=City")},_onRouteMatched:function(){var e=this;var i=this.getView().getModel("viewModel");i.setProperty("/codeEnabled",true);i.setProperty("/buttonText","Save");i.setProperty("/deleteEnabled",false);var o=new t({cityCodeState:"None"});this.setModel(o,"dataModel");this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Cities","GET",{},{},this).then(function(i){var o=new t;o.setData(i);e.getView().setModel(o,"cityModelInfo")}).catch(function(t){a.show(e.resourceBundle.getText("ReqField"))});this.clearCity()},additionalInfoValidation:function(){var e=this.getView().getModel("cityModel");var t=this.getView().getModel("dataModel");if(e.getData().cityCode===""){t.setProperty("/cityCodeState","Error")}else{t.setProperty("/cityCodeState","None")}},cityCodeCheck:function(e){var t=this.getView().getModel("cityModel");var i=t.getData().cityCode;var o=this.getView().getModel("cityModelInfo").getData().results;var a=this.getView().getModel("viewModel");function n(e){return o.filter(function(t){return t.cityCode===e})}var r=n(i);if(r.length>0){t.getData().cityName=r[0].cityName;t.getData().state=r[0].state;a.setProperty("/buttonText","Update");a.setProperty("/deleteEnabled",true);a.setProperty("/codeEnabled",false);this.additionalInfoValidation();this.getView().byId("cityName").focus();t.refresh()}else{t.getData().cityName="";t.getData().state="";a.setProperty("/buttonText","Save");a.setProperty("/deleteEnabled",false);a.setProperty("/codeEnabled",false);this.getView().byId("cityName").focus();this.additionalInfoValidation();t.refresh()}this.getView().byId("cityName").focus();this.getView().byId("cityName").$().find("input").select()},onSubmitCityName:function(){this.getView().byId("cityState").focus();this.getView().byId("cityState").$().find("input").select()},onSumitCityState:function(){this.getView().byId("acceptButton").focus()},clearCity:function(){var e=this.getView().getModel("cityModel");var t=this.getView().getModel("viewModel");var i=this.getView().getModel("dataModel");e.getData().cityName="";e.getData().cityCode="";e.getData().state="";t.setProperty("/codeEnabled",true);t.setProperty("/buttonText","Save");t.setProperty("/deleteEnabled",false);i.setProperty("/cityCode","None");e.refresh()},deleteCity:function(){var e=this;var t=this.getView().getModel("cityModel");var i=t.getData().cityCode;var o=this.getView().getModel("cityModelInfo").getData().results;function n(e){return o.filter(function(t){return t.cityCode===e})}var r=n(i);if(r.length>0){if(!this.customerCityInfo(r[0].cityName)){this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Cities('"+r[0].id+"')","DELETE",{},{},this).then(function(i){a.show(e.resourceBundle.getText("Delete1"));t.getData().cityCode="";t.getData().cityName="";t.getData().state="";t.refresh();e._onRouteMatched()}).catch(function(t){a.show(e.resourceBundle.getText("Delete2"))})}else{a.show(e.resourceBundle.getText("Delete2"))}}else{a.show(e.resourceBundle.getText("available11"))}},customerCityInfo:function(e){var t=this.getView().getModel("customerModelInfo");var i=t.getData().results;function o(e){return i.filter(function(t){return t.City===e})}var a=o(e);if(a.length>0){return true}else{return false}},toggleFullScreen:function(){var e="idFullScreenBtn";var t="__component0---idCity--CityHeader";this.toggleUiTable(e,t)},saveCity:function(){var e=this;var t=this.getView().getModel("cityModel");var i=t.getData().cityCode;var o=this.getView().getModel("cityModelInfo").getData().results;if(t.getData().cityCode===""){this.additionalInfoValidation();a.show(e.resourceBundle.getText("Fields"));return}function n(e){return o.filter(function(t){return t.cityCode===e})}var r=n(i);if(r.length>0){this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Cities('"+r[0].id+"')","PUT",{},t.getData(),this).then(function(t){a.show(e.resourceBundle.getText("Data"));e._onRouteMatched()}).catch(function(t){a.show(e.resourceBundle.getText("Data1"))})}else{this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/City","POST",{},t.getData(),this).then(function(t){a.show(e.resourceBundle.getText("Data"));e._onRouteMatched()}).catch(function(t){a.show(e.resourceBundle.getText("Data1"))})}},_onObjectMatched:function(e){var t=e.getParameter("arguments").objectId;this.getModel().metadataLoaded().then(function(){var e=this.getModel().createKey("city",{Id:t});this._bindView("/"+e)}.bind(this))},getRouter:function(){return sap.ui.core.UIComponent.getRouterFor(this)},_bindView:function(e){var t=this.getModel("objectView"),i=this.getModel();this.getView().bindElement({path:e,events:{change:this._onBindingChange.bind(this),dataRequested:function(){i.metadataLoaded().then(function(){t.setProperty("/busy",true)})},dataReceived:function(){t.setProperty("/busy",false)}}})},_onBindingChange:function(){var e=this.getView(),t=this.getModel("objectView"),i=e.getElementBinding();if(!i.getBoundContext()){this.getRouter().getTargets().display("objectNotFound");return}var o=this.getResourceBundle(),a=e.getBindingContext().getObject(),n=a.Id,r=a.FirstName;t.setProperty("/busy",false);t.setProperty("/saveAsTileTitle",o.getText("saveAsTileTitle",[r]));t.setProperty("/shareOnJamTitle",r);t.setProperty("/shareSendEmailSubject",o.getText("shareSendEmailObjectSubject",[n]));t.setProperty("/shareSendEmailMessage",o.getText("shareSendEmailObjectMessage",[r,n,location.href]))}})});