sap.ui.define(["victoria/controller/BaseController","sap/ui/model/json/JSONModel","victoria/models/formatter","sap/m/MessageToast","sap/m/MessageBox","sap/m/Dialog","sap/ui/core/Fragment"],function(e,t,a,i,o,s,r){"use strict";var l;var n;return e.extend("victoria.controller.CustomerOrders",{formatter:a,onInit:function(){e.prototype.onInit.apply(this);this.resourceBundle=this.getOwnerComponent().getModel("i18n").getResourceBundle();var t=this.getRouter();t.getRoute("customerOrders").attachMatched(this._onRouteMatched,this);var a=this;var i=this.getModel("local").getProperty("/CurrentUser");var o=this.getModel("local").oData.AppUsers[i].UserName;o="Hey "+o;this.getView().byId("idUser").setText(o)},_onRouteMatched:function(){var e=this;e.getView().byId("idCoDate").setDateValue(new Date);var t=new Date;var a=t.getDate();var i=t.getMonth()+1;var o=t.getFullYear();e.getView().byId("idCoDelDate").setDateValue(new Date(o,i,a))},handlePopoverPress:function(e){var t=this;var a=e.getSource();var i=a.getParent();var o=e.getSource(),s=this.getView();if(o.getText()==="Ready"){o.setEnabled(false);o.setText("Delivered");o.setType("Accept")}else{if(!this._pPopover){this._oPopover=sap.ui.xmlfragment("victoria.fragments.Popover",t);this.getView().addDependent(this._oPopover)}this._oPopover.openBy(e.getSource())}},onReady:function(e){this._oPopover.close()},onCancel:function(e){},onBlocked:function(e){this._oPopover.close()},onValueHelp:function(e){this.getCustomerPopup(e)},onMaterialValueHelp:function(){this.getMaterialPopup()},onValueHelpKarigar:function(e){this.getKarigarPopup(e)},onKarigarSelect:function(e,t,a){var i=this;if(e.getParameter("selectedItem")){var o=e.getParameter("selectedItem").getBindingContext().getObject();this.setKarigar(o)}},setKarigar:function(e){var t=this;var a=e.City;var i=e.CustomerCode;var o=e.Name;var s=this.getView().byId("idCoKarigar");if(s){this.getView().byId("idCoKarigar").setValue(i);this.getView().byId("idCoKarigarName").setValue(o)}},onEnter:function(e){let t=e.getSource().getValue();if(!t)return;this.setCustomerFilter(t)},onMaterialEnter:function(e){this.getView().byId("idCoQty").focus();this.getView().byId("idCoQty").$().find("input").select()},onKarigarEnter:function(e){this.getView().byId("idCoRemarks").focus();this.getView().byId("idCoRemarks").$().find("input").select()},onRemarksSubmit:function(e){this.getView().byId("acceptButton").focus()},onMaterialSelect:function(e){var t=e.getParameter("selectedItem").getModel().getProperty(e.getParameter("selectedItem").getBindingContext().getPath());var a=e.getParameter("selectedItem").getText();var i=e.getParameter("selectedItem").getAdditionalText();var o=e.getParameter("selectedItem").getKey();this.getView().getModel("local").setProperty("/customerOrder/Material",this.allMasterData.materialsId[a].id);this.getView().getModel("local").setProperty("/coTemp/MaterialCode",a);this.getView().byId("idCoMaterial").setValue(a);this.getView().byId("idCoMatName").setValue(i);this.getView().byId("idCoMatType").setValue(this.allMasterData.materialsId[a].Type);this.getView().byId("idCoMatKarat").setValue(this.allMasterData.materialsId[a].Karat);this.getView().byId("idCoMatMaking").setValue(this.allMasterData.materialsId[a].Making+"/"+this.allMasterData.materialsId[a].Category)},onPressReportDownload:function(e){const t=this.getView().byId("idCoCustomer").getValue();const a=this;if(t!==""){const e=this.getView().getModel("local").getProperty("/customerOrder/Customer");const t=this.getView().getModel("local").getProperty("/coTemp/CustomerCode");if(e===""){alert("Please, select a valid Customer!")}else{window.open("/customerOrderReport?id="+e+"&code="+t)}}else{window.open("/allCustomerOrderReport?id="+"6043ad0632a5213cb0ec5519"+"&code="+"AA02")}},onConfirm:function(e){var t=this.getView().getModel("local").getProperty("/customerOrder");if(e.getSource().getTitle()==="Material Search"){var a=e.getParameter("selectedItem").getLabel();var i=e.getParameter("selectedItem").getValue();this.getView().byId("idCoMatName").setValue(i);var o=e.getParameter("selectedItem").getBindingContextPath().split("'")[1];this.getView().getModel("local").setProperty("/customerOrder/Material",o);this.getView().getModel("local").setProperty("/coTemp/MaterialCode",a);this.getView().byId("idCoMaterial").setValueState("None");this.getView().byId("idCoMaterial").setValueStateText("");var s=this.allMasterData.materials[o];this.getView().byId("idCoMatType").setValue(s.Type);this.getView().byId("idCoMatKarat").setValue(s.Karat);this.getView().byId("idCoMatMaking").setValue(s.Making+"/"+s.Category)}else if(e.getSource().getTitle()==="Karigar Search"){var r=e.getParameter("selectedItem").getLabel();var l=e.getParameter("selectedItem").getValue();this.getView().byId("idCoKarigarName").setValue(l);this.getView().getModel("local").setProperty("/customerOrder/Karigar",e.getParameter("selectedItem").getBindingContextPath().split("'")[1]);this.getView().getModel("local").setProperty("/coTemp/KarigarCode",r)}else{var n=e.getParameter("selectedItem").getLabel();var d=e.getParameter("selectedItem").getValue();console.log(n,d);this.getView().byId("idCoCustomerText").setText(d);this.getView().getModel("local").setProperty("/customerOrder/Customer",e.getParameter("selectedItem").getBindingContextPath().split("'")[1]);this.getView().getModel("local").setProperty("/coTemp/CustomerCode",n);this.getView().byId("idCoCustomer").setValueState("None");this.getView().byId("idCoCustomer").setValueStateText("");t.Customer=e.getParameter("selectedItem").getBindingContextPath().split("'")[1];var g=new sap.ui.model.Filter("Customer","EQ","'"+t.Customer+"'");this.getView().byId("idCoTable").getBinding("items").filter(g)}},onSearch:function(e){var t=e.getParameter("query");if(!t){t=e.getParameter("value")}var a;if(e.getSource().getTitle()==="Material Search"){var i=new sap.ui.model.Filter("ProductCode",sap.ui.model.FilterOperator.Contains,t);var o=new sap.ui.model.Filter("ProductName",sap.ui.model.FilterOperator.Contains,t);a=new sap.ui.model.Filter({filters:[i,o],and:false})}else{var i=new sap.ui.model.Filter("CustomerCode",sap.ui.model.FilterOperator.Contains,t);var o=new sap.ui.model.Filter("Name",sap.ui.model.FilterOperator.Contains,t);a=new sap.ui.model.Filter({filters:[i,o],and:false})}var s=[a];var r=e.getSource().getBinding("items");r.filter(s)},onDateChange:function(e){var t=e.getSource();var a=e.getParameter("valid");if(a){t.setValueState(sap.ui.core.ValueState.None)}else{t.setValueState(sap.ui.core.ValueState.Error)}var i=e.getSource().getId();if(i.split("--")[2]==="idCoDate"){var o=e.getParameter("value");var s=o.split("-");var r=new Date(s[0],s[1],s[2]);this.getView().byId("idCoDelDate").setDateValue(r)}},onSubmit:function(e){this.getView().byId("idCoWeight").focus();this.getView().byId("idCoWeight").$().find("input").select()},onSubmitWeight:function(e){this.getView().byId("idCoMaking").focus();this.getView().byId("idCoMaking").$().find("input").select()},onSubmitMaking:function(e){this.getView().byId("idSize").focus();this.getView().byId("idSize").$().find("input").select()},onSizeSubmit:function(e){this.getView().byId("idCoKarigar").focus();this.getView().byId("idCoKarigar").$().find("input").select()},onCoCashSubmit:function(e){this.getView().byId("idCoGold").focus();this.getView().byId("idCoGold").$().find("input").select()},onCoGoldSubmit:function(e){this.getView().byId("idCoSilver").focus();this.getView().byId("idCoSilver").$().find("input").select()},onCoSilverSubmit:function(e){this.getView().byId("acceptButton").focus()},onSelectPhoto:function(e){var a=this;if(e.getSource().getId().includes("idOrderPictureUpload")){if(!a.photoPopup){a.photoPopup=new sap.ui.xmlfragment("victoria.fragments.PhotoUploadDialog",a);a.getView().addDependent(a.photoPopup)}var i=new t;i.setData();a.getView().setModel(i,"photo");a.photoPopup.open()}else{this.selRow=e.getSource().getBindingContext().getObject();var o=e.getSource().getBindingContext().getPath()+"/ToPhotos";console.log(e.getSource().getBindingContext().getPath(),o);this.ODataHelper.callOData(this.getOwnerComponent().getModel(),o,"GET",{},{},this).then(function(e){if(!a.photoPopup){a.photoPopup=new sap.ui.xmlfragment("victoria.fragments.PhotoUploadDialog",a);a.getView().addDependent(a.photoPopup)}var i=new t;i.setData(e.results[0]);a.getView().setModel(i,"photo");a.photoPopup.open()}).catch(function(e){a.getView().setBusy(false)})}},onSelectPhoto2:function(e){var t=this;if(!t.photoPopup2){t.photoPopup2=new sap.ui.xmlfragment("victoria.fragments.PhotoUploadDialog2",t);t.getView().addDependent(t.photoPopup2)}t.photoPopup2.open()},handleOkPress:function(){sap.ui.getCore().byId("idCoUploader2").setValue();this.photoPopup2.close()},handleCancelPress:function(){sap.ui.getCore().byId("idCoUploader2").setValue();var e=new t;e.setData();this.getView().setModel(e,"photo2");this.photoPopup2.close()},onFileUploaderChange2:function(){var e=this;var a=sap.ui.getCore().byId("idCoUploader2");if(a.getValue()){var i=jQuery.sap.domById(a.getId()+"-fu").files[0];var o=i.name;var s=i.type;var r=new FileReader;r.onload=function(a){var i={};i.imgContent=a.currentTarget.result;var r=i.imgContent;var l=new t;l.setData({Content:r,Filename:o,Filetype:s});e.getView().setModel(l,"photo2")};r.readAsDataURL(i)}},handleUploadPress:function(e){var t=sap.ui.getCore().byId("idCoUploader");var a=this;if(t.getValue()){this.flag="U";var i=jQuery.sap.domById(t.getId()+"-fu").files[0];this.fileName=i.name;this.fileType=i.type;var o=new FileReader;o.onload=function(e){var t={};t.imgContent=e.currentTarget.result;var i=t.imgContent;var o=a;a.savePicToDb(a.fileName,a.fileType,i)};o.readAsDataURL(i)}else if(this.flag==="C"){var s="Capture";this.savePicToDb(this.attachName,"jpeg",document.getElementById(s).toDataURL())}else{sap.m.MessageToast.show(a.resourceBundle.getText("Pic1"));return}},handleCapturePress:function(){var e=this;this.flag="C";this.fixedDialog=new s({title:"Click on Capture to take photo",beginButton:new sap.m.Button({text:"Capture Photo",press:function(t){e.imageVal=document.getElementById("player");var a=t.getSource();e.attachName=a.getParent().getContent()[1].getValue();e.fixedDialog.close()}}),content:[new sap.ui.core.HTML({content:"<video id='player' autoplay></video>"}),new sap.m.Input({placeholder:"please enter image name here",required:true})],endButton:new sap.m.Button({text:"Cancel",press:function(){e.fixedDialog.close()}})});this.getView().addDependent(this.fixedDialog);this.fixedDialog.open();this.fixedDialog.attachBeforeClose(this.setImage,this);var t=function(e){player.srcObject=e};navigator.mediaDevices.getUserMedia({video:true}).then(t)},setImage:function(){var e=this.getView().getDependents()[0].getContent()[0].getContent()[0];var t="Capture";var a=t+"-text";var i=this.imageVal;var o=new sap.ui.core.HTML({content:"<canvas id='"+t+"' width='320px' height='320px' "+" style='2px solid red'></canvas> "+" <label id='"+a+"'>"+this.attachName+"</label>"});e.addItem(o);o.addEventDelegate({onAfterRendering:function(){var e=document.getElementById(t);var a=e.getContext("2d");a.drawImage(i,0,0,e.width,e.height)}})},savePicToDb:function(e,a,i){var o=this;if(this.selRow&&this.selRow.Picture==="X"){var s=this.getView().getModel("photo").getData().id;var r={id:s,Content:i,name:this.fileName,type:this.fileType};$.post("/updatePhoto",r).done(function(e,a){sap.m.MessageToast.show(o.resourceBundle.getText("Pic2"));var i=new t;i.setData(r);o.getView().setModel(i,"photo")}).fail(function(e,t,a){sap.m.MessageBox.error(o.resourceBundle.getText("Pic3")+", "+a)})}else{var o=this;var r={CustomerOrderId:this.selRow.id,Content:i,Filename:this.fileName,Filetype:this.fileType};this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Photos","POST",{},r,this).then(function(e){sap.m.MessageToast.show(o.resourceBundle.getText("Pic4"));var a=new t;a.setData(e);o.getView().setModel(a,"photo");o.selRow.Picture="X";var i={id:o.selRow.id,PhotoValue:o.selRow.Picture};$.post("/updatePhotoFlag",i).done(function(e,t){sap.m.MessageToast.show(o.resourceBundle.getText("Data12"))}).fail(function(e,t,a){sap.m.MessageBox.error(o.resourceBundle.getText("Update12"))});o.onClear();o.getView().setBusy(false)}).catch(function(e){o.getView().setBusy(false);var t=o.getErrorMessage(e)})}},savePicToDb2:function(e,a,i,o){var s=this;var r={CustomerOrderId:o,Content:i,Filename:e,Filetype:a};this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Photos","POST",{},r,this).then(function(e){sap.m.MessageToast.show(s.resourceBundle.getText("Pic4"));var a=new t;a.setData();s.getView().setModel(a,"photo2");var i={id:o,PhotoValue:"X"};$.post("/updatePhotoFlag",i).done(function(e,t){sap.m.MessageToast.show(s.resourceBundle.getText("Data12"))}).fail(function(e,t,a){sap.m.MessageBox.error(s.resourceBundle.getText("Update12"))});s.onClear();s.getView().setBusy(false)}).catch(function(e){s.getView().setBusy(false);var a=new t;a.setData();s.getView().setModel(a,"photo2");var i=s.getErrorMessage(e)})},handleClosePress:function(e){var t=sap.ui.getCore().byId("idCoUploader");t.setValue("");this.photoPopup.close()},onSave:function(e){var t=this;let a=this.resourceBundle;var i=this.getView().getModel("local").getProperty("/customerOrder");i.Date=this.getView().byId("idCoDate").getDateValue();i.DelDate=this.getView().byId("idCoDelDate").getDateValue();if(i.Cash==0&&i.Gold==0&&i.Silver==0&&i.Qty==0&&i.Weight==0){o.show(a.getText("ATLEASTONE"));return}var s=this.isCustOrderDataValid(i);if(!s.isValid){s.errMessages.forEach(e=>{let t=this.getView().byId(e.sFieldId);t.setValueState("Error");t.setValueStateText(e.sMessage)});this.getView().byId(s.errMessages[0].sFieldId).focus();return}this.getView().getModel("local").setProperty("/customerOrder/Date",i.Date);this.getView().getModel("local").setProperty("/customerOrder/DelDate",i.DelDate);this.getView().setBusy(true);this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/CustomerOrders","POST",{},i,this).then(function(e){t.getView().setBusy(false);if(t.getView().getModel("photo2")&&t.getView().getModel("photo2").getData().Content){var a=t.getView().getModel("photo2").getData();t.savePicToDb2(a.Filename,a.Filetype,a.Content,e.id)}sap.m.MessageToast.show(t.resourceBundle.getText("dataSucess"));t.onClear()}).catch(function(e){t.getView().setBusy(false);var a=t.getErrorMessage(e)})},isCustOrderDataValid:function(e){let t={isValid:true,errMessages:[]};let a=this.resourceBundle;if(!e.Date){t.errMessages.push({sMessage:a.getText("DATE_CANNOT_BE_BLANK_VS"),sFieldId:"idCoDate"})}else{this.getView().byId("idCoDate").setValueState("None");this.getView().byId("idCoDate").setValueStateText("")}if(!e.DelDate){t.errMessages.push({sMessage:a.getText("DATE_CANNOT_BE_BLANK_VS"),sFieldId:"idCoDelDate"})}else{if(e.Date>e.DelDate){t.errMessages.push({sMessage:a.getText("DATE_GREATER_THAN_DELV"),sFieldId:"idCoDelDate"})}else{this.getView().byId("idCoDelDate").setValueState("None");this.getView().byId("idCoDelDate").setValueStateText("")}}if(!e.Customer){t.errMessages.push({sMessage:a.getText("CUSTOMER_BLANK_VS"),sFieldId:"idCoCustomer"})}else{this.getView().byId("idCoCustomer").setValueState("None");this.getView().byId("idCoCustomer").setValueStateText("")}if(!e.Material){t.errMessages.push({sMessage:a.getText("MATERIAL_BLANK"),sFieldId:"idCoMaterial"})}else{this.getView().byId("idCoMaterial").setValueState("None");this.getView().byId("idCoMaterial").setValueStateText("")}if(t.errMessages.length){t.isValid=false}return t},onDelete:function(){var e=this;sap.m.MessageBox.confirm(e.resourceBundle.getText("Do1"),{title:"Confirm",styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit,onClose:function(t){if(t===o.Action.OK){var a=e.byId("idCoTable").getSelectedItems();if(a.length){for(var i=0;i<a.length;i++){var s=a[i].getBindingContext().sPath;e.ODataHelper.callOData(e.getOwnerComponent().getModel(),s,"DELETE",{},{},e)}}sap.m.MessageToast.show(e.resourceBundle.getText("Selected12"))}}})},onClear:function(){var e=this;this.getView().byId("idCoDate").setDateValue(new Date);var a=new Date;var i=a.getDate();var o=a.getMonth()+1;var s=a.getFullYear();this.getView().byId("idCoDelDate").setDateValue(new Date(s,o,i));this.byId("idCoMaterial").setValue("");this.byId("idCoMatName").setValue("");this.byId("idCoMatType").setValue("");this.byId("idCoMatKarat").setValue("");this.byId("idCoMatMaking").setValue("");this.byId("idCoQty").setValue("1");this.byId("idCoWeight").setValue("0");this.byId("idCoMaking").setValue("0");this.byId("idCoRemarks").setValue("");this.byId("idCoCash").setValue("0");this.byId("idCoGold").setValue("0");this.byId("idCoSilver").setValue("0");this.byId("idCoKarigar").setValue("");this.byId("idCoKarigarName").setValue("");this.getView().getModel("local").setProperty("/coTemp/MaterialCode","");this.getView().getModel("local").setProperty("/coTemp/CustomerCode","");this.getView().getModel("local").setProperty("/coTemp/KarigarCode","");this.getView().getModel("local").setProperty("/customerOrder/Karigar","");this.getView().getModel("local").setProperty("/customerOrder/Material","");this.getView().getModel("local").setProperty("/customerOrder/Customer","");this.getView().getModel("local").setProperty("/customerOrder/Picture","");this.getView().byId("idCoTable").getBinding("items").filter([]);var r=new t;r.setData();e.getView().setModel(r,"photo2")},onRefresh:function(){this.onClear()},onSuggest:function(e){const t=e.key;var a=e.getParameter("id").split("--")[2];var i=e.getParameter("suggestValue");if(i===""||t==8||t==="Backspace"||t==="Delete"){this.getView().byId("idCoCustomer").setValue("");return}if(!i){i=e.getParameter("newValue")}if(i){var o=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("CustomerCode",sap.ui.model.FilterOperator.Contains,i.toUpperCase()),new sap.ui.model.Filter("Name",sap.ui.model.FilterOperator.Contains,i.toUpperCase())],and:false})}e.getSource().getBinding("suggestionItems").filter(o);var s=new sap.ui.model.Sorter({path:"CustomerCode",descending:false});e.getSource().getBinding("suggestionItems").sort(s);this.getView().byId("idCoCustomer").setValue(i)},onSuggest1:function(e){const t=e.key;var a=e.getParameter("id").split("--")[2];var i=e.getParameter("suggestValue");if(i===""||t==8||t==="Backspace"||t==="Delete"){this.getView().byId("idCoKarigar").setValue("");return}if(!i){i=e.getParameter("newValue")}if(i){var o=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("CustomerCode",sap.ui.model.FilterOperator.Contains,i.toUpperCase()),new sap.ui.model.Filter("Name",sap.ui.model.FilterOperator.Contains,i.toUpperCase())],and:false})}e.getSource().getBinding("suggestionItems").filter(o);var s=new sap.ui.model.Sorter({path:"CustomerCode",descending:false});e.getSource().getBinding("suggestionItems").sort(s);this.getView().byId("idCoKarigar").setValue(i)},onUpdateFinished:function(e){var t=e.getSource();var a=t.getItems();var i=a.length;var o;var s;var r;var l=this.getView().getModel("i18n").getProperty("coTableTitle");this.getView().byId("idCoTable").getHeaderToolbar().getTitleControl().setText(l+" "+"("+i+")");for(var n=0;n<i;n++){var d=t.getItems()[n].getCells()[3].getText();var g=this.allMasterData.customers[d];t.getItems()[n].getCells()[2].setText(g.CustomerCode+" - "+g.Name);var u=t.getItems()[n].getCells()[5].getText();var c=this.allMasterData.materials[u];t.getItems()[n].getCells()[4].setText(c.ProductCode+" - "+c.ProductName);var h=t.getItems()[n].getCells()[15].getText();if(h!=="null"&&h!==""){var g=this.allMasterData.customers[h];t.getItems()[n].getCells()[14].setText(g.CustomerCode+" - "+g.Name)}var p=t.getItems()[n].getCells()[9].getText();if(p==="null"){t.getItems()[n].getCells()[9].setText(" ")}}}})});
//# sourceMappingURL=CustomerOrders.controller.js.map