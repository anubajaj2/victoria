sap.ui.define(["victoria/controller/BaseController","sap/ui/model/json/JSONModel","victoria/models/formatter","sap/m/MessageToast","sap/m/MessageBox","sap/m/Dialog","sap/ui/core/Fragment"],function(e,t,a,i,s,o,r){"use strict";var l;var n;return e.extend("victoria.controller.CustomerOrders",{formatter:a,buttonState:"12",onInit:function(){e.prototype.onInit.apply(this);this.resourceBundle=this.getOwnerComponent().getModel("i18n").getResourceBundle();var t=this.getRouter();t.getRoute("customerOrders").attachMatched(this._onRouteMatched,this);var a=this;var i=this.getModel("local").getProperty("/CurrentUser");var s=this.getModel("local").oData.AppUsers[i].UserName;s="Hey "+s;this.getView().byId("idUser").setText(s)},_onRouteMatched:function(){var e=this;e.getView().byId("idCoDate").setDateValue(new Date);var t=new Date;var a=t.getDate();var i=t.getMonth()+1;var s=t.getFullYear();e.getView().byId("idCoDelDate").setDateValue(new Date(s,i,a))},handlePopoverPress:function(e){var t=this;var a=e.getSource();var i=a.getParent();this.buttonState=i.getCells()[10];var s=e.getSource(),o=this.getView();if(s.getText()==="Ready"){s.setEnabled(false);s.setText("Delivered");s.setType("Accept")}else{if(!this._pPopover){this._oPopover=sap.ui.xmlfragment("victoria.fragments.Popover",t);this.getView().addDependent(this._oPopover)}this._oPopover.openBy(e.getSource())}},onReady:function(e){this.buttonState.setText("Ready");this.buttonState.setType("Critical");this._oPopover.close()},onCancel:function(e){this.buttonState.setEnabled(false);this.buttonState.setText("Cancelled");this.buttonState.setType("Reject");this._oPopover.close()},onBlocked:function(e){this.buttonState.setEnabled(false);this.buttonState.setText("Blocked");this.buttonState.setType("Reject");this._oPopover.close()},onValueHelp:function(e){this.getCustomerPopup(e)},onMaterialValueHelp:function(){this.getMaterialPopup()},onValueHelpKarigar:function(e){this.getKarigarPopup(e)},onKarigarSelect:function(e,t,a){var i=this;if(e.getParameter("selectedItem")){var s=e.getParameter("selectedItem").getBindingContext().getObject();this.setKarigar(s)}},setKarigar:function(e){var t=this;var a=e.City;var i=e.CustomerCode;var s=e.Name;var o=this.getView().byId("idCoKarigar");if(o){this.getView().byId("idCoKarigar").setValue(i);this.getView().byId("idCoKarigarName").setValue(s)}},onEnter:function(e){this.getView().byId("idCoMaterial").focus();this.getView().byId("idCoMaterial").$().find("input").select()},onMaterialEnter:function(e){this.getView().byId("idCoQty").focus();this.getView().byId("idCoQty").$().find("input").select()},onKarigarEnter:function(e){this.getView().byId("idCoRemarks").focus();this.getView().byId("idCoRemarks").$().find("input").select()},onRemarksSubmit:function(e){this.getView().byId("acceptButton").focus()},onMaterialSelect:function(e){var t=e.getParameter("selectedItem").getModel().getProperty(e.getParameter("selectedItem").getBindingContext().getPath());var a=e.getParameter("selectedItem").getText();var i=e.getParameter("selectedItem").getAdditionalText();var s=e.getParameter("selectedItem").getKey();this.getView().getModel("local").setProperty("/customerOrder/Material",this.allMasterData.materialsId[a].id);this.getView().getModel("local").setProperty("/coTemp/MaterialCode",a);this.getView().byId("idCoMaterial").setValue(a);this.getView().byId("idCoMatName").setValue(i);this.getView().byId("idCoMatType").setValue(this.allMasterData.materialsId[a].Type);this.getView().byId("idCoMatKarat").setValue(this.allMasterData.materialsId[a].Karat);this.getView().byId("idCoMatMaking").setValue(this.allMasterData.materialsId[a].Making+"/"+this.allMasterData.materialsId[a].Category)},onPressReportDownload:function(e){const t=this.getView().byId("idCoCustomer").getValue();const a=this;if(t!==""){const e=this.getView().getModel("local").getProperty("/customerOrder/Customer");const t=this.getView().getModel("local").getProperty("/coTemp/CustomerCode");if(e===""){alert("Please, select a valid Customer!")}else{window.open("/customerOrderReport?id="+e+"&code="+t)}}else{window.open("/allCustomerOrderReport?id="+"6043ad0632a5213cb0ec5519"+"&code="+"AA02")}},onConfirm:function(e){var t=this.getView().getModel("local").getProperty("/customerOrder");if(e.getSource().getTitle()==="Material Search"){var a=e.getParameter("selectedItem").getLabel();var i=e.getParameter("selectedItem").getValue();this.getView().byId("idCoMatName").setValue(i);var s=e.getParameter("selectedItem").getBindingContextPath().split("'")[1];this.getView().getModel("local").setProperty("/customerOrder/Material",s);this.getView().getModel("local").setProperty("/coTemp/MaterialCode",a);this.getView().byId("idCoMaterial").setValueState("None");this.getView().byId("idCoMaterial").setValueStateText("");var o=this.allMasterData.materials[s];this.getView().byId("idCoMatType").setValue(o.Type);this.getView().byId("idCoMatKarat").setValue(o.Karat);this.getView().byId("idCoMatMaking").setValue(o.Making+"/"+o.Category)}else if(e.getSource().getTitle()==="Karigar Search"){var r=e.getParameter("selectedItem").getLabel();var l=e.getParameter("selectedItem").getValue();this.getView().byId("idCoKarigarName").setValue(l);this.getView().getModel("local").setProperty("/customerOrder/Karigar",e.getParameter("selectedItem").getBindingContextPath().split("'")[1]);this.getView().getModel("local").setProperty("/coTemp/KarigarCode",r)}else{var n=e.getParameter("selectedItem").getLabel();var d=e.getParameter("selectedItem").getValue();console.log(n,d);this.getView().byId("idCoCustomerText").setText(d);this.getView().getModel("local").setProperty("/customerOrder/Customer",e.getParameter("selectedItem").getBindingContextPath().split("'")[1]);this.getView().getModel("local").setProperty("/coTemp/CustomerCode",n);this.getView().byId("idCoCustomer").setValueState("None");this.getView().byId("idCoCustomer").setValueStateText("");t.Customer=e.getParameter("selectedItem").getBindingContextPath().split("'")[1];var g=new sap.ui.model.Filter("Customer","EQ","'"+t.Customer+"'");this.getView().byId("idCoTable").getBinding("items").filter(g)}},onSearch:function(e){var t=e.getParameter("query");if(!t){t=e.getParameter("value")}var a;if(e.getSource().getTitle()==="Material Search"){var i=new sap.ui.model.Filter("ProductCode",sap.ui.model.FilterOperator.Contains,t);var s=new sap.ui.model.Filter("ProductName",sap.ui.model.FilterOperator.Contains,t);a=new sap.ui.model.Filter({filters:[i,s],and:false})}else{var i=new sap.ui.model.Filter("CustomerCode",sap.ui.model.FilterOperator.Contains,t);var s=new sap.ui.model.Filter("Name",sap.ui.model.FilterOperator.Contains,t);a=new sap.ui.model.Filter({filters:[i,s],and:false})}var o=[a];var r=e.getSource().getBinding("items");r.filter(o)},onDateChange:function(e){var t=e.getSource();var a=e.getParameter("valid");if(a){t.setValueState(sap.ui.core.ValueState.None)}else{t.setValueState(sap.ui.core.ValueState.Error)}var i=e.getSource().getId();if(i.split("--")[2]==="idCoDate"){var s=e.getParameter("value");var o=s.split("-");var r=new Date(o[0],o[1],o[2]);this.getView().byId("idCoDelDate").setDateValue(r)}},onSubmit:function(e){this.getView().byId("idCoWeight").focus();this.getView().byId("idCoWeight").$().find("input").select()},onSubmitWeight:function(e){this.getView().byId("idCoMaking").focus();this.getView().byId("idCoMaking").$().find("input").select()},onSubmitMaking:function(e){this.getView().byId("idSize").focus();this.getView().byId("idSize").$().find("input").select()},onSizeSubmit:function(e){this.getView().byId("idCoKarigar").focus();this.getView().byId("idCoKarigar").$().find("input").select()},onCoCashSubmit:function(e){this.getView().byId("idCoGold").focus();this.getView().byId("idCoGold").$().find("input").select()},onCoGoldSubmit:function(e){this.getView().byId("idCoSilver").focus();this.getView().byId("idCoSilver").$().find("input").select()},onCoSilverSubmit:function(e){this.getView().byId("acceptButton").focus()},onSelectPhoto:function(e){var a=this;if(e.getSource().getId().includes("idOrderPictureUpload")){if(!a.photoPopup){a.photoPopup=new sap.ui.xmlfragment("victoria.fragments.PhotoUploadDialog",a);a.getView().addDependent(a.photoPopup)}var i=new t;i.setData();a.getView().setModel(i,"photo");a.photoPopup.open()}else{this.selRow=e.getSource().getBindingContext().getObject();var s=e.getSource().getBindingContext().getPath()+"/ToPhotos";console.log(e.getSource().getBindingContext().getPath(),s);this.ODataHelper.callOData(this.getOwnerComponent().getModel(),s,"GET",{},{},this).then(function(e){if(!a.photoPopup){a.photoPopup=new sap.ui.xmlfragment("victoria.fragments.PhotoUploadDialog",a);a.getView().addDependent(a.photoPopup)}var i=new t;i.setData(e.results[0]);a.getView().setModel(i,"photo");a.photoPopup.open()}).catch(function(e){a.getView().setBusy(false)})}},onSelectPhoto2:function(e){var t=this;if(!t.photoPopup2){t.photoPopup2=new sap.ui.xmlfragment("victoria.fragments.PhotoUploadDialog2",t);t.getView().addDependent(t.photoPopup2)}t.photoPopup2.open()},handleOkPress:function(){sap.ui.getCore().byId("idCoUploader2").setValue();this.photoPopup2.close()},handleCancelPress:function(){sap.ui.getCore().byId("idCoUploader2").setValue();var e=new t;e.setData();this.getView().setModel(e,"photo2");this.photoPopup2.close()},onFileUploaderChange2:function(){var e=this;var a=sap.ui.getCore().byId("idCoUploader2");if(a.getValue()){var i=jQuery.sap.domById(a.getId()+"-fu").files[0];var s=i.name;var o=i.type;var r=new FileReader;r.onload=function(a){var i={};i.imgContent=a.currentTarget.result;var r=i.imgContent;var l=new t;l.setData({Content:r,Filename:s,Filetype:o});e.getView().setModel(l,"photo2")};r.readAsDataURL(i)}},handleUploadPress:function(e){var t=sap.ui.getCore().byId("idCoUploader");var a=this;if(t.getValue()){this.flag="U";var i=jQuery.sap.domById(t.getId()+"-fu").files[0];this.fileName=i.name;this.fileType=i.type;var s=new FileReader;s.onload=function(e){var t={};t.imgContent=e.currentTarget.result;var i=t.imgContent;var s=a;a.savePicToDb(a.fileName,a.fileType,i)};s.readAsDataURL(i)}else if(this.flag==="C"){var o="Capture";this.savePicToDb(this.attachName,"jpeg",document.getElementById(o).toDataURL())}else{sap.m.MessageToast.show(a.resourceBundle.getText("Pic1"));return}},handleCapturePress:function(){var e=this;this.flag="C";this.fixedDialog=new o({title:"Click on Capture to take photo",beginButton:new sap.m.Button({text:"Capture Photo",press:function(t){e.imageVal=document.getElementById("player");var a=t.getSource();e.attachName=a.getParent().getContent()[1].getValue();e.fixedDialog.close()}}),content:[new sap.ui.core.HTML({content:"<video id='player' autoplay></video>"}),new sap.m.Input({placeholder:"please enter image name here",required:true})],endButton:new sap.m.Button({text:"Cancel",press:function(){e.fixedDialog.close()}})});this.getView().addDependent(this.fixedDialog);this.fixedDialog.open();this.fixedDialog.attachBeforeClose(this.setImage,this);var t=function(e){player.srcObject=e};navigator.mediaDevices.getUserMedia({video:true}).then(t)},setImage:function(){var e=this.getView().getDependents()[0].getContent()[0].getContent()[0];var t="Capture";var a=t+"-text";var i=this.imageVal;var s=new sap.ui.core.HTML({content:"<canvas id='"+t+"' width='320px' height='320px' "+" style='2px solid red'></canvas> "+" <label id='"+a+"'>"+this.attachName+"</label>"});e.addItem(s);s.addEventDelegate({onAfterRendering:function(){var e=document.getElementById(t);var a=e.getContext("2d");a.drawImage(i,0,0,e.width,e.height)}})},savePicToDb:function(e,a,i){var s=this;if(this.selRow&&this.selRow.Picture==="X"){var o=this.getView().getModel("photo").getData().id;var r={id:o,Content:i,name:this.fileName,type:this.fileType};$.post("/updatePhoto",r).done(function(e,a){sap.m.MessageToast.show(s.resourceBundle.getText("Pic2"));var i=new t;i.setData(r);s.getView().setModel(i,"photo")}).fail(function(e,t,a){sap.m.MessageBox.error(s.resourceBundle.getText("Pic3")+", "+a)})}else{var s=this;var r={CustomerOrderId:this.selRow.id,Content:i,Filename:this.fileName,Filetype:this.fileType};this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Photos","POST",{},r,this).then(function(e){sap.m.MessageToast.show(s.resourceBundle.getText("Pic4"));var a=new t;a.setData(e);s.getView().setModel(a,"photo");s.selRow.Picture="X";var i={id:s.selRow.id,PhotoValue:s.selRow.Picture};$.post("/updatePhotoFlag",i).done(function(e,t){sap.m.MessageToast.show(s.resourceBundle.getText("Data12"))}).fail(function(e,t,a){sap.m.MessageBox.error(s.resourceBundle.getText("Update12"))});s.onClear();s.getView().setBusy(false)}).catch(function(e){s.getView().setBusy(false);var t=s.getErrorMessage(e)})}},savePicToDb2:function(e,a,i,s){var o=this;var r={CustomerOrderId:s,Content:i,Filename:e,Filetype:a};this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Photos","POST",{},r,this).then(function(e){sap.m.MessageToast.show(o.resourceBundle.getText("Pic4"));var a=new t;a.setData();o.getView().setModel(a,"photo2");var i={id:s,PhotoValue:"X"};$.post("/updatePhotoFlag",i).done(function(e,t){sap.m.MessageToast.show(o.resourceBundle.getText("Data12"))}).fail(function(e,t,a){sap.m.MessageBox.error(o.resourceBundle.getText("Update12"))});o.onClear();o.getView().setBusy(false)}).catch(function(e){o.getView().setBusy(false);var a=new t;a.setData();o.getView().setModel(a,"photo2");var i=o.getErrorMessage(e)})},handleClosePress:function(e){var t=sap.ui.getCore().byId("idCoUploader");t.setValue("");this.photoPopup.close()},onSave:function(e){var t=this;var a=this.getView().getModel("local").getProperty("/customerOrder");a.Date=this.getView().byId("idCoDate").getDateValue();a.DelDate=this.getView().byId("idCoDelDate").getDateValue();var i=this.isCustOrderDataValid(a);if(!i.isValid){i.errMessages.forEach(e=>{let t=this.getView().byId(e.sFieldId);t.setValueState("Error");t.setValueStateText(e.sMessage)});this.getView().byId(i.errMessages[0].sFieldId).focus();return}this.getView().getModel("local").setProperty("/customerOrder/Date",a.Date);this.getView().getModel("local").setProperty("/customerOrder/DelDate",a.DelDate);this.getView().setBusy(true);this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/CustomerOrders","POST",{},a,this).then(function(e){t.getView().setBusy(false);if(t.getView().getModel("photo2")&&t.getView().getModel("photo2").getData().Content){var a=t.getView().getModel("photo2").getData();t.savePicToDb2(a.Filename,a.Filetype,a.Content,e.id)}sap.m.MessageToast.show(t.resourceBundle.getText("dataSucess"));t.onClear()}).catch(function(e){t.getView().setBusy(false);var a=t.getErrorMessage(e)})},isCustOrderDataValid:function(e){let t={isValid:true,errMessages:[]};let a=this.resourceBundle;if(!e.Date){t.errMessages.push({sMessage:a.getText("DATE_CANNOT_BE_BLANK_VS"),sFieldId:"idCoDate"})}else{this.getView().byId("idCoDate").setValueState("None");this.getView().byId("idCoDate").setValueStateText("")}if(!e.DelDate){t.errMessages.push({sMessage:a.getText("DATE_CANNOT_BE_BLANK_VS"),sFieldId:"idCoDelDate"})}else{if(e.Date>e.DelDate){t.errMessages.push({sMessage:a.getText("DATE_GREATER_THAN_DELV"),sFieldId:"idCoDelDate"})}else{this.getView().byId("idCoDelDate").setValueState("None");this.getView().byId("idCoDelDate").setValueStateText("")}}if(!e.Customer){t.errMessages.push({sMessage:a.getText("CUSTOMER_BLANK_VS"),sFieldId:"idCoCustomer"})}else{this.getView().byId("idCoCustomer").setValueState("None");this.getView().byId("idCoCustomer").setValueStateText("")}if(!e.Material){t.errMessages.push({sMessage:a.getText("MATERIAL_BLANK"),sFieldId:"idCoMaterial"})}else{this.getView().byId("idCoMaterial").setValueState("None");this.getView().byId("idCoMaterial").setValueStateText("")}if(!e.Qty||parseFloat(e.Qty)<=0){t.errMessages.push({sMessage:a.getText("QTY_GREATER_THAN_VS"),sFieldId:"idCoQty"})}else{this.getView().byId("idCoQty").setValueState("None");this.getView().byId("idCoQty").setValueStateText("")}if(!e.Weight||parseFloat(e.Weight)<=0){t.errMessages.push({sMessage:a.getText("WEIGHT_GREATER_THAN_VS"),sFieldId:"idCoWeight"})}else{this.getView().byId("idCoWeight").setValueState("None");this.getView().byId("idCoWeight").setValueStateText("")}if(t.errMessages.length){t.isValid=false}return t},onDelete:function(){var e=this;sap.m.MessageBox.confirm(e.resourceBundle.getText("Do1"),{title:"Confirm",styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit,onClose:function(t){if(t===s.Action.OK){var a=e.byId("idCoTable").getSelectedItems();if(a.length){for(var i=0;i<a.length;i++){var o=a[i].getBindingContext().sPath;e.ODataHelper.callOData(e.getOwnerComponent().getModel(),o,"DELETE",{},{},e)}}sap.m.MessageToast.show(e.resourceBundle.getText("Selected12"))}}})},onClear:function(){var e=this;this.getView().byId("idCoDate").setDateValue(new Date);var a=new Date;var i=a.getDate();var s=a.getMonth()+1;var o=a.getFullYear();this.getView().byId("idCoDelDate").setDateValue(new Date(o,s,i));this.byId("idCoMaterial").setValue("");this.byId("idCoMatName").setValue("");this.byId("idCoMatType").setValue("");this.byId("idCoMatKarat").setValue("");this.byId("idCoMatMaking").setValue("");this.byId("idCoQty").setValue("1");this.byId("idCoWeight").setValue("0");this.byId("idCoMaking").setValue("0");this.byId("idCoRemarks").setValue("");this.byId("idCoCash").setValue("0");this.byId("idCoGold").setValue("0");this.byId("idCoSilver").setValue("0");this.byId("idCoKarigar").setValue("");this.byId("idCoKarigarName").setValue("");this.getView().getModel("local").setProperty("/coTemp/MaterialCode","");this.getView().getModel("local").setProperty("/coTemp/CustomerCode","");this.getView().getModel("local").setProperty("/coTemp/KarigarCode","");this.getView().getModel("local").setProperty("/customerOrder/Karigar","");this.getView().getModel("local").setProperty("/customerOrder/Material","");this.getView().getModel("local").setProperty("/customerOrder/Customer","");this.getView().getModel("local").setProperty("/customerOrder/Picture","");this.getView().byId("idCoTable").getBinding("items").filter([]);var r=new t;r.setData();e.getView().setModel(r,"photo2")},onRefresh:function(){this.onClear()},onSuggest:function(e){const t=e.key;var a=e.getParameter("id").split("--")[2];var i=e.getParameter("suggestValue");if(i===""||t==8||t==="Backspace"||t==="Delete"){this.getView().byId("idCoCustomer").setValue("");return}if(!i){i=e.getParameter("newValue")}if(i){var s=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("CustomerCode",sap.ui.model.FilterOperator.Contains,i.toUpperCase()),new sap.ui.model.Filter("Name",sap.ui.model.FilterOperator.Contains,i.toUpperCase())],and:false})}e.getSource().getBinding("suggestionItems").filter(s);var o=new sap.ui.model.Sorter({path:"CustomerCode",descending:false});e.getSource().getBinding("suggestionItems").sort(o);this.getView().byId("idCoCustomer").setValue(i)},onSuggest1:function(e){const t=e.key;var a=e.getParameter("id").split("--")[2];var i=e.getParameter("suggestValue");if(i===""||t==8||t==="Backspace"||t==="Delete"){this.getView().byId("idCoKarigar").setValue("");return}if(!i){i=e.getParameter("newValue")}if(i){var s=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("CustomerCode",sap.ui.model.FilterOperator.Contains,i.toUpperCase()),new sap.ui.model.Filter("Name",sap.ui.model.FilterOperator.Contains,i.toUpperCase())],and:false})}e.getSource().getBinding("suggestionItems").filter(s);var o=new sap.ui.model.Sorter({path:"CustomerCode",descending:false});e.getSource().getBinding("suggestionItems").sort(o);this.getView().byId("idCoKarigar").setValue(i)},onUpdateFinished:function(e){var t=e.getSource();var a=t.getItems();var i=a.length;var s;var o;var r;var l=this.getView().getModel("i18n").getProperty("coTableTitle");this.getView().byId("idCoTable").getHeaderToolbar().getTitleControl().setText(l+" "+"("+i+")");for(var n=0;n<i;n++){var d=t.getItems()[n].getCells()[3].getText();var g=this.allMasterData.customers[d];t.getItems()[n].getCells()[2].setText(g.CustomerCode+" - "+g.Name);var u=t.getItems()[n].getCells()[5].getText();var h=this.allMasterData.materials[u];t.getItems()[n].getCells()[4].setText(h.ProductCode+" - "+h.ProductName);var c=t.getItems()[n].getCells()[11].getText();if(c!=="null"&&c!==""){var g=this.allMasterData.customers[c];t.getItems()[n].getCells()[10].setText(g.CustomerCode+" - "+g.Name)}var p=t.getItems()[n].getCells()[9].getText();if(p==="null"){t.getItems()[n].getCells()[9].setText(" ")}}}})});
//# sourceMappingURL=CustomerOrders.controller.js.map