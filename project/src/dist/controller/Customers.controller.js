sap.ui.define(["victoria/controller/BaseController","sap/ui/model/json/JSONModel","sap/ui/core/routing/History","victoria/models/formatter","sap/m/MessageToast","sap/ui/model/Filter"],function(e,t,o,s,r,a){"use strict";return e.extend("victoria.controller.Customers",{formatter:s,onInit:function(){var o=this;var s=this.getModel("local").getProperty("/CurrentUser");var r=this.getModel("local").oData.AppUsers[s].UserName;r="Hey "+r;this.getView().byId("idUser").setText(r);this.resourceBundle=this.getOwnerComponent().getModel("i18n").getResourceBundle();var a,i=new t({Id:"",City:"",MobilePhone:"0",Address:"",CustomerCode:"",Name:"",SecondaryPhone:"0",Group:"",Type:"",Interest:"0"});var d=new t({items:[{text:"Sikar"},{text:"Churu"},{text:"Jaipur"}]});var n=new t({items:[{text:"gm"},{text:"pcs"}]});var l=new t({items:[{text:"Retail Customer"},{text:"Agent"},{text:"Karigar"},{text:"Retailer"},{text:"Maker"},{text:"Kata Center"}]});this.setModel(i,"customerModel");this.setModel(d,"fixed");this.setModel(n,"per");this.setModel(l,"typec");e.prototype.onInit.apply(this);var u=new t({buttonText:"Save",deleteEnabled:false,codeEnabled:true});this.setModel(u,"viewModel");var g=this.getRouter();g.getRoute("Customers").attachMatched(this._onRouteMatched,this)},onSuggestionItemSelected:function(e){var t=e.getParameter("selectedItem").getModel().getProperty(e.getParameter("selectedItem").getBindingContext().getPath()).id;this.getView().getModel("customerModel").setProperty("/City",t)},onPressCustCodeDownload:function(){window.open("/custCodeDownload?type=Customer_Codes")},onSelectChange:function(e){var t=e.getSource().getId();var o=e.getParameter("selectedItem").mProperties.key;if(t==="__component0---idCustomers--idType"){this.getView().getModel("customerModel").setProperty("/Type",o);this.getView().byId("idCityField").focus()}if(t==="__component0---idCustomers--idGroup"){this.getView().getModel("customerModel").setProperty("/Group",o);this.getView().byId("idType").focus()}},onSelectChangeGroup:function(e){var t=e.getParameter("selectedItem").getText();this.getView().getModel("customerModel").setProperty("/Group",t)},getRouter:function(){return sap.ui.core.UIComponent.getRouterFor(this)},_onRouteMatched:function(){var e=this;var o=this.getView().getModel("viewModel");o.setProperty("/codeEnabled",true);o.setProperty("/buttonText","Save");o.setProperty("/deleteEnabled",false);var s=new t({CustomerCodeState:"None",CityState:"None",GroupState:"None",NameState:"None",TypeState:"None"});this.setModel(s,"dataModel");this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Customers","GET",{},{},this).then(function(o){var s=new t;s.setData(o);e.getView().setModel(s,"customerModelInfo")}).catch(function(t){r.show(e.resourceBundle.getText("ReqField"))});this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Groups","GET",{},{},this).then(function(o){var s=new t;s.setData(o);e.getView().setModel(s,"groupModelInfo")}).catch(function(t){r.show(e.resourceBundle.getText("ReqField"))});this.clearCustomer();$(document).keydown(function(t){var o=document.URL.split("/");if(o[o.length-1]==="Customers"){if(t.keyCode==68&&t.ctrlKey&&t.altKey){t.preventDefault();e.deleteAllCustomers()}else if(t.keyCode==69&&t.ctrlKey&&t.altKey){t.preventDefault();e.deleteAllEntrys()}else if(t.keyCode==65&&t.ctrlKey&&t.altKey){t.preventDefault();e.deleteAllTables()}}})},_myFunction1:function(){},onKeyPress:function(e){var t=e.getSource();t.setValue(t.getValue().toUpperCase())},toggleFullScreen:function(){var e="idFullScreenBtn";var t="__component0---idCustomers--CustomerHeader";this.toggleUiTable(e,t)},deleteAllCustomers:function(){var e=this;sap.m.MessageBox.confirm("Do you want to Delete All Customers?",{title:"Confirm",actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],styleClass:"",onClose:function(e){if(e==="OK"){$.post("/deleteRecords",{entityName:"Customer"}).done(function(e){sap.m.MessageToast.show(e.msg)})}}})},deleteAllEntrys:function(){var e=this;sap.m.MessageBox.confirm("Do you want to Delete All Entrys?",{title:"Confirm",actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],styleClass:"",onClose:function(e){if(e==="OK"){$.post("/deleteRecords",{entityName:"EntryD"}).done(function(e){sap.m.MessageToast.show(e.msg)})}}})},deleteAllTables:function(){var e=this;sap.m.MessageBox.confirm("Do you want to Delete All Tables?",{title:"Confirm",actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],styleClass:"",onClose:function(e){if(e==="OK"){$.post("/deleteRecords",{entityName:"DelAll"}).done(function(e){sap.m.MessageToast.show(e.msg)})}}})},additionalInfoValidation:function(){var e=this.getView().getModel("customerModel");var t=this.getView().getModel("dataModel");if(e.getData().CustomerCode===""){t.setProperty("/CustomerCodeState","Error")}else{t.setProperty("/CustomerCodeState","None")}if(e.getData().Name===""){t.setProperty("/NameState","Error")}else{t.setProperty("/NameState","None")}if(e.getData().Group===""){var o=this.byId("idGroup").getSelectedKey();e.setProperty("/Group",o)}else{t.setProperty("/GroupState","None")}if(e.getData().City===""){var o=this.byId("idCityField").getSelectedKey();e.setProperty("/City",o)}else{t.setProperty("/CityState","None")}if(e.getData().Type===""){var o=this.byId("idType").getSelectedKey();e.setProperty("/Type",o)}else{t.setProperty("/TypeState","None")}},ValueChangeCustomer:function(e){var t=e.getSource();var o=new sap.ui.model.Filter("CustomerCode",sap.ui.model.FilterOperator.Contains,e.getParameter("suggestValue").toLocaleUpperCase());t.getBinding("suggestionItems").filter(o)},customerCodeEnter:function(e){this.getView().byId("idName").focus();var o=this;var s=this;var r=this.getView().getModel("customerModel");var a=e.getParameter("value").toLocaleUpperCase();r.setProperty("/CustomerCode",a);var i=new sap.ui.model.Filter("CustomerCode","EQ",a);this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Customers","GET",{filters:[i]},{},this).then(function(e){var o=new t;o.setData(e);var i=o.getData().results[0];var d=s.getView().getModel("dataModel");var n=s.getView().getModel("viewModel");s.getView().byId("idCustomerCode").setValue(a);var l=s.getView().byId("idCustomerCode").getValue();if(i.id.length>0){r.setProperty("/CustomerCode",i.id);r.setProperty("/City",i.City);r.setProperty("/Name",i.Name);r.setProperty("/MobilePhone",i.MobilePhone);r.setProperty("/Address",i.Address);r.setProperty("/SecondaryPhone",i.SecondaryPhone);r.setProperty("/Interest",i.Interest);var u=s.getView().byId("idGroup");u.setSelectedKey(i.Group);r.setProperty("/Group",i.Group);var g=s.getView().byId("idCityField");g.setSelectedKey(s.allMasterData.cities[i.City].cityCode);s.getView().byId("idCityField").setValue(s.allMasterData.cities[i.City].cityCode);console.log(s.allMasterData.cities);console.log(i.City);console.log(s.allMasterData.cities[i.City]);r.setProperty("/Id",i.id);var c=s.getView().byId("idType");c.setSelectedKey(i.Type);r.setProperty("/Type",i.Type);n.setProperty("/buttonText","Update");n.setProperty("/deleteEnabled",true);n.setProperty("/codeEnabled",false);d.setProperty("/typeEnabled",true);r.refresh()}else{r.getData().City="";r.getData().MobilePhone="0";r.getData().Address="";r.getData().Name="";r.getData().SecondaryPhone="0";r.getData().Interest="0";r.getData().Group="";r.getData().Type="";n.setProperty("/buttonText","Save");n.setProperty("/deleteEnabled",false);n.setProperty("/codeEnabled",false)}}).catch(function(e){})},customerNameSubmit:function(){this.getView().byId("idAddress").focus()},customerAddressSubmit:function(){this.getView().byId("idGroup").focus()},customerCitySubmit:function(){this.getView().byId("idMobilePhone").focus();this.getView().byId("idMobilePhone").$().find("input").select()},customerMobilePhoneSubmit:function(){this.getView().byId("idSecondaryPhone").focus();this.getView().byId("idSecondaryPhone").$().find("input").select()},customerSecondaryPhoneSubmit:function(){this.getView().byId("idInterest").focus();this.getView().byId("idInterest").$().find("input").select()},customerInterest:function(){this.getView().byId("customerAccept").focus()},customerCodeCheck:function(e){var t=this.getView().getModel("customerModel");var o=e.getParameter("selectedItem").getModel().getProperty(e.getParameter("selectedItem").getBindingContext().getPath());var s=o.CustomerCode;var r=this.getView().getModel("dataModel");var a=this.getView().getModel("viewModel");var i=this.getView().byId("idCustomerCode").getValue();var d=s;if(d.length>0){t.setProperty("/CustomerCode",o.id);t.setProperty("/City",o.City);t.setProperty("/Name",o.Name);t.setProperty("/MobilePhone",o.MobilePhone);t.setProperty("/Address",o.Address);t.setProperty("/SecondaryPhone",o.SecondaryPhone);t.setProperty("/Interest",o.Interest);var n=this.getView().byId("idGroup");n.setSelectedKey(o.Group);t.setProperty("/Group",o.Group);var l=this.getView().byId("idCityField");t.setProperty("/Id",o.id);var u=this.getView().byId("idType");u.setSelectedKey(o.Type);t.setProperty("/Type",o.Type);a.setProperty("/buttonText","Update");a.setProperty("/deleteEnabled",true);a.setProperty("/codeEnabled",false);r.setProperty("/typeEnabled",true);this.additionalInfoValidation();this.getView().byId("idName").focus()}else{t.getData().City="";t.getData().MobilePhone="0";t.getData().Address="";t.getData().Name="";t.getData().SecondaryPhone="0";t.getData().Interest="0";t.getData().Group="";t.getData().Type="";a.setProperty("/buttonText","Save");a.setProperty("/deleteEnabled",false);a.setProperty("/codeEnabled",false);that.getView().byId("idName").focus();t.refresh()}},clearCustomer:function(){this.getView().byId("idCustomerCode").setEditable(true);var e=this.getView().getModel("customerModel");var t=this.getView().getModel("viewModel");var o=this.getView().getModel("dataModel");var s=this.getView().getModel("typec");e.getData().CustomerCode="";e.getData().City="";e.getData().MobilePhone="0";e.getData().Address="";e.getData().Name="";e.getData().CustomerCode="";e.getData().SecondaryPhone="0";e.getData().Interest="0";t.setProperty("/codeEnabled",true);t.setProperty("/buttonText","Save");t.setProperty("/deleteEnabled",false);o.setProperty("/CustomerCodeState","None");e.getData().CustomerCode="";var r=this.getView().byId("idCustomerCode");r.setSelectedKey("");var a=s.getData().items[0].text;var i=this.getView().byId("idType");i.setSelectedKey(a);var d=this.getView().byId("idGroup");d.setSelectedKey("");var n=this.getView().byId("idCityField");n.setSelectedKey("");o.setProperty("/CityState","None");o.setProperty("/GroupState","None");o.setProperty("/NameState","None");e.refresh();var r=this.getView().byId("idCustomerCode");r.setSelectedKey("");r.setValue("")},SaveCustomer:function(){var e=this;var t=this.getView().getModel("customerModel");var o=t.getData().Id;var s=e.getView().byId("idCustomerCode").getValue();t.setProperty("/CustomerCode",s);var a=t.getProperty("/CustomerCode").toLocaleUpperCase();t.setProperty("/CustomerCode",a);e.additionalInfoValidation();var i=true;if(t.getData().Name===""||t.getData().CustomerCode===""){e.additionalInfoValidation();r.show(e.resourceBundle.getText("Fields"));i=false}if(i===true){if(o.length>0){this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Customers('"+o+"')","PUT",{},t.getData(),this).then(function(t){r.show(e.resourceBundle.getText("Data"));e.clearCustomer()}).catch(function(t){r.show(e.resourceBundle.getText("Data1"))})}else{var e=this;var d=new sap.ui.model.Filter("CustomerCode","EQ",a);this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Customers","GET",{filters:[d]},{},this).then(function(o){if(o.results.length>0){r.show(e.resourceBundle.getText("Data2"))}else{e.ODataHelper.callOData(e.getOwnerComponent().getModel(),"/Customer","POST",{},t.getData(),e).then(function(t){r.show(e.resourceBundle.getText("Data"));e.clearCustomer()}).catch(function(t){r.show(e.resourceBundle.getText("Data1"))})}}).catch(function(e){})}}t.refresh()},deleteCustomer:async function(){var e=this;e.getView().setBusy(true);var t=this.getView().getModel("customerModel");var o=t.getData().Id;var s=this.getView().getModel("customerModelInfo").getData().results;if(t.getData().CustomerCode===""||t.getData().Name===""||t.getData().City===""||t.getData().Group===""){r.show(e.resourceBundle.getText("Fields"));e.getView().setBusy(false);return}function a(e){return s.filter(function(t){return t.CustomerCode===e})}var i=a(o);var d=this.getView().getModel("typec");var n=true;var e=this;var l=["/Entrys","/OrderHeaders","/WSOrderHeaders","/CustomerOrders","/BookingDetails","/BookingDlvDetails","/Kacchis"];var u=new sap.ui.model.Filter("Customer","EQ","'"+o+"'");for(var g=0;g<l.length;g++){await this.ODataHelper.callOData(this.getOwnerComponent().getModel(),l[g],"GET",{filters:[u]},{},this).then(function(t){if(t.results.length>0){e.Errmsg();n=true}else{n=false}}).catch(function(t){var o=e.getErrorMessage(t)});if(n===true){break;e.getView().setBusy(false)}}if(n===false){this.deleteCnfCustomer(o,t);this.getView().setBusy(false)}},Errmsg:function(){r.show(that.resourceBundle.getText("Customer1"));this.getView().setBusy(false)},deleteCnfCustomer:function(e,t){var o=this;sap.m.MessageBox.confirm("Do you want to delete Customer",{title:"Confirm",actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],styleClass:"",onClose:function(s){if(s==="OK"){o.ODataHelper.callOData(o.getOwnerComponent().getModel(),"/Customers('"+e+"')","DELETE",{},{},o).then(function(e){r.show(o.resourceBundle.getText("Delete1"));t.getData().City="";t.getData().MobilePhone="0";t.getData().Address="";t.getData().CustomerCode="";t.getData().Name="";t.getData().SecondaryPhone="0";t.getData().Interest="0";t.getData().Group="";t.refresh();o.clearCustomer()}).catch(function(e){r.show(o.resourceBundle.getText("Delete2"))})}}})},selectedCustomer:function(e){var t=e.getParameter("selectedItem");var o=t.getText();var s=t.getKey();var r=this;console.log(o);console.log(s);this.getModel().read("/Customers("+s+")",{success:function(e){r.getModel("customerModel").setData(e);r.getModel("customerModel").setProperty("/City",e.CitycodeDetails.Code)}})},onNavBack:function(){var e=o.getInstance().getPreviousHash(),t=sap.ushell.Container.getService("CrossApplicationNavigation");if(e!==undefined||!t.isInitialNavigation()){history.go(-1)}else{this.getRouter().navTo("worklist",{},true)}},createNewCustomer:function(){var e=this;var t={Address:this.byId("idAddress").getValue(),Attachments:"",BusinessPhone:"",Citycode:parseInt(this.byId("idCityField").getSelectedKey()),Company:this.byId("customerCode").getValue(),CountryRegion:"",Customgroup:parseInt(this.byId("idCustomGrp").getSelectedKey()),EmailAddress:null,FaxNumber:"",FirstName:this.byId("idName").getValue(),HasInterest:this.byId("idSendSMS").getState(),HomePhone:null,JobTitle:"",LastName:"",MobilePhone:this.byId("idMobilePhone").getValue(),Notes:null,Standardgroup:parseInt(this.byId("idGroup").getSelectedKey()),StateProvince:"",WebPage:"",ZipPostalCode:this.byId("idZipPostalCode").getValue(),Type:parseInt(this.byId("idType").getSelectedKey()),CitycodeDetails:{__metadata:{uri:"http://localhost:8080/bhavysoft/galaxyService.svc/Citycodes("+this.byId("idCityField").getSelectedKey()+")"}},CustomgroupDetails:{__metadata:{uri:"http://localhost:8080/bhavysoft/galaxyService.svc/Customgroups("+this.byId("idCustomGrp").getSelectedKey()+")"}},StandardgroupDetails:{__metadata:{uri:"http://localhost:8080/bhavysoft/galaxyService.svc/Standardgroups("+this.byId("idGroup").getSelectedKey()+")"}}};this.getModel().create("/Customers",t,{success:function(){r.show(e.resourceBundle.getText("create1"));this.getModel().refresh()}})},updateCustomer:function(){var e=this;var t={Address:this.byId("idAddress").getValue(),Attachments:"",BusinessPhone:"",Citycode:parseInt(this.byId("idCityField").getSelectedKey()),Company:this.byId("customerCode").getValue(),CountryRegion:"",Customgroup:parseInt(this.byId("idCustomGrp").getSelectedKey()),EmailAddress:null,FaxNumber:"",FirstName:this.byId("idName").getValue(),HasInterest:this.byId("idSendSMS").getState(),HomePhone:null,JobTitle:"",LastName:"",MobilePhone:this.byId("idMobilePhone").getValue(),Notes:null,Standardgroup:parseInt(this.byId("idGroup").getSelectedKey()),StateProvince:"",WebPage:"",ZipPostalCode:this.byId("idZipPostalCode").getValue(),Type:parseInt(this.byId("idType").getSelectedKey()),CitycodeDetails:{__metadata:{uri:"http://localhost:8080/bhavysoft/galaxyService.svc/Citycodes("+this.byId("idCityField").getSelectedKey()+")"}},CustomgroupDetails:{__metadata:{uri:"http://localhost:8080/bhavysoft/galaxyService.svc/Customgroups("+this.byId("idCustomGrp").getSelectedKey()+")"}},StandardgroupDetails:{__metadata:{uri:"http://localhost:8080/bhavysoft/galaxyService.svc/Standardgroups("+this.byId("idGroup").getSelectedKey()+")"}}};this.getModel().update("/Customers("+e.getModel("customerModel").getProperty("/Id")+")",t,{success:function(){r.show(e.resourceBundle.getText("Update1"))}})},clearValues:function(){this.getModel("customerModel").setProperty("/Id","");this.getModel("customerModel").setProperty("/City","");this.getModel("customerModel").setProperty("/Company","");this.getModel("customerModel").setProperty("/FirstName","");this.getModel("customerModel").setProperty("/LastName","");this.getModel("customerModel").setProperty("/MobilePhone",0);this.getModel("customerModel").setProperty("/Address",0);this.getModel("customerModel").setProperty("/ZipPostalCode",0)},deleteProduct:function(){var e=this;this.getModel().remove("/Customers("+e.getModel("customerModel").getProperty("/Id")+")",{success:function(){r.show(e.resourceBundle.getText("Delete1"));e.clearValues()}})},Save:function(){var e=this;var t=[];var o=new a("Company","EQ",e.getModel("customerModel").getProperty("/Company"));t.push(o);this.getModel().read("/Customers",{filters:t,success:function(t){if(t.results.length===0){e.createNewCustomer()}else{e.updateCustomer()}}})},_onObjectMatched:function(e){var t=e.getParameter("arguments").objectId;this.getModel().metadataLoaded().then(function(){var e=this.getModel().createKey("Customers",{Id:t});this._bindView("/"+e)}.bind(this))},_bindView:function(e){var t=this.getModel("objectView"),o=this.getModel();this.getView().bindElement({path:e,events:{change:this._onBindingChange.bind(this),dataRequested:function(){o.metadataLoaded().then(function(){t.setProperty("/busy",true)})},dataReceived:function(){t.setProperty("/busy",false)}}})},_onBindingChange:function(){var e=this.getView(),t=this.getModel("objectView"),o=e.getElementBinding();if(!o.getBoundContext()){this.getRouter().getTargets().display("objectNotFound");return}var s=this.getResourceBundle(),r=e.getBindingContext().getObject(),a=r.Id,i=r.FirstName;t.setProperty("/busy",false);t.setProperty("/saveAsTileTitle",s.getText("saveAsTileTitle",[i]));t.setProperty("/shareOnJamTitle",i);t.setProperty("/shareSendEmailSubject",s.getText("shareSendEmailObjectSubject",[a]));t.setProperty("/shareSendEmailMessage",s.getText("shareSendEmailObjectMessage",[i,a,location.href]))}})});