sap.ui.define(["victoria/controller/BaseController","sap/ui/model/json/JSONModel","sap/ui/core/routing/History","victoria/models/formatter","sap/m/MessageToast","sap/ui/model/Filter","sap/m/MessageBox"],function(e,t,a,r,i,o,s){"use strict";var l;return e.extend("victoria.controller.Kacchi",{formatter:r,onInit:function(){debugger;this.resourceBundle=this.getOwnerComponent().getModel("i18n").getResourceBundle();e.prototype.onInit.apply(this);var t=this.getRouter();t.getRoute("Kacchi").attachMatched(this._onRouteMatched,this);var a=this;var r=this.getModel("local").getProperty("/CurrentUser");var i=this.getModel("local").oData.AppUsers[r].UserName;i="Hey "+i;this.getView().byId("idUser").setText(i);this.byId("idTransferButton").setEnabled(false)},getRouter:function(){return this.getOwnerComponent().getRouter()},_onRouteMatched:function(e){var t=this;t.clearScreen();t.createModel();t.byId("idSaveIcon").setColor("green")},onSelDelete:function(){debugger;var e=this.byId("idCustTable");var t=e.getBinding("rows").getLength();var a=this.getView().getModel("kachhiLocalModel").getProperty("/kachhiData");var r=this.getView().byId("idCustTable").getSelectedIndices();for(var i=r.length-1;i>=0;--i){a.splice(r[i],1);a.push({id:"",deleteInd:"",Date:"",Customer:"",PaggaNo:0,Weight:0,Tunch:0,Fine:0})}this.getView().getModel("kachhiLocalModel").setProperty("/kachhiData",a);e.clearSelection()},toggleFullScreen:function(e){debugger;var t="idFullScreenBtn";var a="idKacchiHead";this.toggleUiTable(t,a)},getTotals:function(){debugger;var e=0,t=0,a=0,r=0,i=0,o=0;this.byId("idItemsCount").setText("");this.byId("idTotalWeight").setText("");this.byId("idTotalFine").setText("");this.byId("idTotalTunch").setText("");var s=this.byId("idCustTable");var l=this.byId("idItemsCount");var n=this.byId("idTotalWeight");var g=this.byId("idTotalTunch");var d=this.byId("idTotalFine");var c=s.getBinding("rows").getLength();var u=this.getView().getModel("kachhiLocalModel").getProperty("/kachhiData");for(var h=0;h<c;h++){var v=s.getContextByIndex(h);var b=v.getProperty("PaggaNo");var f=v.getProperty("Weight");var y=v.getProperty("Tunch");var p=v.getProperty("Fine");if(b){t=t+1;l.setText(t);if(f){a=+a+ +f;a=a.toFixed(2);n.setText(a)}if(y){i=i+1;r=(+r+ +y)/i;r=r.toFixed(2);g.setText(r)}if(p){o=+o+ +p;o=o.toFixed(2);d.setText(o)}}}},onSuggest:function(e){debugger;const t=e.key;var a=e.getParameter("id").split("--")[2];var r=e.getParameter("suggestValue");if(r===""||t==8||t==="Backspace"||t==="Delete"){this.getView().byId("idCustNo").setValue("");return}if(!r){r=e.getParameter("newValue")}if(r){var i=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("CustomerCode",sap.ui.model.FilterOperator.Contains,r.toUpperCase()),new sap.ui.model.Filter("Name",sap.ui.model.FilterOperator.Contains,r.toUpperCase())],and:false})}e.getSource().getBinding("suggestionItems").filter(i);var o=new sap.ui.model.Sorter({path:"CustomerCode",descending:false});e.getSource().getBinding("suggestionItems").sort(o);this.getView().byId("idCustNo").setValue(r)},onliveChange:function(e){debugger;var t=0;this.byId("idSaveIcon").setColor("red");var a=e.getSource().getParent();var r=a.getCells();var i=r[0].getValue;var o=r[1].getValue;var s=r[2].getValue;if(o!==0||o!==""){r[1].setValueState(sap.ui.core.ValueState.None)}if(s!==0||s!==""){r[2].setValueState(sap.ui.core.ValueState.None)}if(i){t=r[1].getValue()*r[2].getValue()/100;if(t!=0){t=t.toFixed(2);r[3].setValue(t)}else{r[3].setValue(t)}var l=r[2].getValue();if(l>100){r[2].setValueState("Error").setValueStateText("Tunch can not be greater then 100")}else{r[2].setValueState(sap.ui.core.ValueState.None)}}this.getTotals()},onliveChangeWeight:function(e){debugger;var t=0;this.byId("idSaveIcon").setColor("red");var a=e.getSource().getParent();var r=a.getCells();var i=r[0].getValue;var o=r[1].getValue;var s=r[2].getValue;if(o!==0||o!==""){r[1].setValueState(sap.ui.core.ValueState.None);if(this.getView().byId("idRb1").getSelected()){var l=e.mParameters.value.match(/^[+-]?\d{0,5}(\.\d{0,2})?/)[0];r[1].setValue(l)}else if(this.getView().byId("idRb2").getSelected()){var l=e.mParameters.value.match(/^[+-]?\d{0,6}(\.\d{0,3})?/)[0];r[1].setValue(l)}}if(s!==0||s!==""){r[2].setValueState(sap.ui.core.ValueState.None)}if(i){t=r[1].getValue()*r[2].getValue()/100;if(t!=0){t=t.toFixed(3);r[3].setValue(t)}else{r[3].setValue(t)}var n=r[2].getValue();if(n>100){r[2].setValueState("Error").setValueStateText("Tunch can not be greater then 100")}else{r[2].setValueState(sap.ui.core.ValueState.None)}}this.getTotals()},onTransfer:function(){debugger;var e=this;var t=this.byId("idSaveIcon").getColor();var a=this.byId("idTotalFine").getText();if(this.validateCustomer()===true&&t=="green"&&a!==""){e.getView().setBusy(true);var r=this.getView().getModel("local").getProperty("/EntryData");r.Date=this.getView().byId("idDate").getDateValue();r.Remarks="[Auto-Entry]kachhi parchi on"+" "+r.Date;r.Silver="-"+this.byId("idTotalFine").getText();r.Customer=this.customerId;this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Entrys","POST",{},r,this).then(function(t){e.getView().setBusy(false);sap.m.MessageToast.show(e.resourceBundle.getText("Transferred"))}).catch(function(t){e.getView().setBusy(false);var a=e.getErrorMessage(t)});this.kachhiBackup()}else if(t=="red"){s.show(e.resourceBundle.getText("Please12"),{icon:s.Icon.ERROR,title:"Error",actions:[s.Action.OK],onClose:function(e){}})}else if(a==""||a==0){s.show(e.resourceBundle.getText("Please13"),{icon:s.Icon.ERROR,title:"Error",actions:[s.Action.OK],onClose:function(e){}})}},kachhiBackup:function(){var e=this;this.getView().setBusy(true);var t=this.getView().getModel("kachhiLocalModel").getProperty("/kachhiData");for(var a=0;a<t.length;a++){var r=this.getView().getModel("kachhiLocalModel").getProperty("/kachhiData")[a];if(r.PaggaNo!==0){r.Customer=this.getView().getModel("local").getProperty("/kacchiData").Customer;r.Date=this.getView().byId("idDate").getDateValue();if(this.validateAll(r,a)===true){this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/KacchisBackup","POST",{},r,this).then(function(t){e.getView().setBusy(false);e.byId("idSaveIcon").setColor("green")}).catch(function(t){e.getView().setBusy(false);var a=e.getErrorMessage(t)});var i=this.getView().getModel("kachhiLocalModel").getProperty("/kachhiData")[a].id;var o="/Kacchis('"+i+"')";if(i!==""){e.ODataHelper.callOData(e.getOwnerComponent().getModel(),o,"DELETE",{},{},e)}}}}e.getView().byId("idCustTable").clearSelection();e.byId("idTransferButton").setEnabled(false);e.clearScreen();e.createModel();e.getView().setBusy(false)},onPrint:function(e){var t;debugger;var a="<center><h3>Kachhi Report</h3></center><hr>"+"<table width='40%'><tr><td><b>Date:</b></td><td>"+this.byId("idDate").getValue()+"</td></tr>"+"<tr><td><b>Customer Name:</b></td><td>"+this.byId("idCustName").getText()+"</td></tr></table><br>";var r="<table width='40%'><tr><td><b>Total Weight:</b></td><td>"+this.byId("idTotalWeight").getText()+"</td></tr>"+"<tr><td><b>Total Fine:</b></td><td>"+this.byId("idTotalFine").getText()+"</td></tr></table><br>";var i="<table style='border-collapse: collapse;border:1px solid black;'width='95%'';'text-align:center';'border-spacing: 5px';><tr><th style=border:1px solid black;>pagga</th><th style=border:1px solid black;>Weight</th><th style=border:1px solid black;>Tunch</th><th style=border:1px solid black;>Fine</th></tr>";var o=this.getView().getModel("kachhiLocalModel").getProperty("/kachhiData");for(t=0;t<o.length;t++){if(o[t].PaggaNo){i+="<tr>";i+="</td><td style='border: 1px solid black;'>"+o[t].PaggaNo+"</td><td style='border: 1px solid black;'>"+o[t].Weight+"</td><td style='border: 1px solid black;'>"+o[t].Tunch+"</td><td style='border: 1px solid black;'>"+o[t].Fine+"</td></tr>"}}i+="</table>";var s=window.open("","PrintWindow","width=200,height=100");s.document.write(a+i+"<br>"+r);s.print();s.stop()},createModel:function(){var e=new t;var a=[];for(var r=1;r<=20;r++){var i={id:"",deleteInd:"",Date:"",Customer:"",PaggaNo:0,Weight:0,Tunch:0,Fine:0};a.push(i)}e.setData({kachhiData:a,kacchiHeader:{cdate:new Date,customer:""}});this.getView().setModel(e,"kachhiLocalModel");this.byId("idDate").setDateValue(new Date)},onCustValueHelp:function(e){debugger;this.getCustomerPopup(e)},onPressKacchiDownload:function(){debugger;var e=this.getView().getModel("local");debugger;var t="Kacchi";var a=e.oData.kacchiData.Customer;var r=e.oData.kachhiHeaderTemp.CustomerName;window.open("/kaachiDownload?type=Kacchi&id="+a+"&name="+r)},validateCustomer:function(){var e=this;var t=true;var a=this.byId("idCustNo").getValue();if(a===""){t=false;s.show("Please Select Customer first",{icon:s.Icon.ERROR,title:"Error",actions:[s.Action.OK],onClose:function(t){if(t===s.Action.OK){e.getView().byId("idCustNo").setValueState("Error").setValueStateText("Customer is Mandatory Input")}}})}return t},validateAll:function(e,t){debugger;var a=true;var r=this.getView().getModel("kachhiLocalModel").getProperty("/kachhiData");var i=this.getView().byId("idCustTable");var o=i.getBinding("rows");if(e.PaggaNo!==0||e.PaggaNo!==""){if(e.Weight==0||e.Weight===""){i.getRows()[t].getCells()[1].setValueState("Error").setValueStateText("Weight Can't be Initial");a=false;return}else{i.getRows()[t].getCells()[1].setValueState("None")}if(e.Tunch==0||e.Tunch===""){i.getRows()[t].getCells()[2].setValueState("Error").setValueStateText("Tunch Can't be Initial");a=false;return}else{i.getRows()[t].getCells()[2].setValueState("None")}}return a},onSave:function(e){debugger;var t=this;var a=t.byId("idItemsCount").getText();if(a==0||a==""){s.show(t.resourceBundle.getText("Save11"),{icon:s.Icon.ERROR,title:"Error",actions:[s.Action.OK],onClose:function(e){}})}else if(this.validateCustomer()===true){this.getView().setBusy(true);var r=this.getView().getModel("kachhiLocalModel").getProperty("/kachhiData");var i=this.getView().byId("idCustTable");var o=i.getBinding("rows");for(var l=0;l<o.getLength();l++){var n=this.getView().getModel("kachhiLocalModel").getProperty("/kachhiData")[l];if(n.PaggaNo!==0){n.Customer=this.getView().getModel("local").getProperty("/kacchiData").Customer;n.Date=this.getView().byId("idDate").getDateValue();if(this.validateAll(n,l)===true&&n.id==""){this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Kacchis","POST",{},n,this).then(function(e){t.getView().setBusy(false);sap.m.MessageToast.show(t.resourceBundle.getText("dataSave"));debugger;var a=e.id;var r=e.PaggaNo;var i=t.getView().getModel("kachhiLocalModel").getProperty("/kachhiData");for(var o=0;o<i.length;o++){if(i[o].PaggaNo==e.PaggaNo){i[o].id=a;break}}t.getView().getModel("kachhiLocalModel").setProperty("/kachhiData",i);t.byId("idSaveIcon").setColor("green");t.byId("idTransferButton").setEnabled(true)}).catch(function(e){t.getView().setBusy(false);var a=t.getErrorMessage(e)})}}else{}}}this.getView().setBusy(false)},onConfirmMessageBox:function(e,t,a,r,i){},onClear:function(){debugger;var e=this;var t=this.byId("idSaveIcon").getColor();if(t=="red"){sap.m.MessageBox.confirm(e.resourceBundle.getText("Are11"),{title:"Confirm",styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit,actions:["Save & Clear","Clear",s.Action.CANCEL],onClose:function(t){if(t==="Clear"){e.clearScreen();e.createModel();e.byId("idSaveIcon").setColor("green");sap.m.MessageToast.show(e.resourceBundle.getText("Screen11"))}else if(t==="Save & Clear"){e.onSave();e.clearScreen();e.createModel();e.byId("idSaveIcon").setColor("green");sap.m.MessageToast.show(e.resourceBundle.getText("Screen12"))}}})}else if(t=="green"){sap.m.MessageBox.confirm(e.resourceBundle.getText("Are11"),{title:"Confirm",styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit,actions:["Clear",s.Action.CANCEL],onClose:function(t){if(t==="Clear"){e.clearScreen();e.createModel();e.byId("idSaveIcon").setColor("green");sap.m.MessageToast.show(e.resourceBundle.getText("Screen11"))}}})}},clearScreen:function(){var e=this;e.byId("idCustNo").setValue("");e.byId("idCustName").setText("");e.byId("idDate").setDateValue(new Date);e.byId("idItemsCount").setText("");e.byId("idTotalWeight").setText("");e.byId("idTotalFine").setText("");e.byId("idTotalTunch").setText("")},onDelete:function(e){debugger;var t=this;var a=t.byId("idItemsCount").getText();if(a==0||a==""){s.show(t.resourceBundle.getText("Screen13"),{icon:s.Icon.ERROR,title:"Error",actions:[s.Action.OK],onClose:function(e){}})}else{sap.m.MessageBox.confirm(t.resourceBundle.getText("Screen14"),{title:"Confirm",styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit,onClose:function(e){debugger;if(e===s.Action.OK){var a=t.getView().byId("idCustTable").getSelectedIndices();var r=t.getView().getModel("kachhiLocalModel").getProperty("/kachhiData");if(a.length){for(var i=0;i<a.length;i++){var o=a[i];var l=r[o].id;if(l!==""){var n="/Kacchis('"+l+"')";t.ODataHelper.callOData(t.getOwnerComponent().getModel(),n,"DELETE",{},{},t)}}t.onSelDelete();t.getTotals();sap.m.MessageToast.show(t.resourceBundle.getText("Selected12"))}else{s.show(t.resourceBundle.getText("Screen15"),{icon:s.Icon.ERROR,title:"Error",actions:[s.Action.OK],onClose:function(e){}})}}}})}},clearHeaderTotal:function(){this.byId("idItemsCount").setText("");this.byId("idTotalWeight").setText("");this.byId("idTotalFine").setText("");this.byId("idTotalTunch").setText("")},getCustDataFromDB:function(e){var t=this;this.getView().setBusy(true);this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Kacchis","GET",{filters:[e]},{},this).then(function(e){debugger;t.getView().setBusy(false);if(e.results.length>0){t.createModel();var a=t.getView().getModel("kachhiLocalModel").getProperty("/kachhiData");for(var r=0;r<e.results.length;r++){debugger;a[r].PaggaNo=e.results[r].PaggaNo;a[r].id=e.results[r].id;a[r].Tunch=e.results[r].Tunch;a[r].Weight=e.results[r].Weight;a[r].Fine=e.results[r].Fine}t.getView().getModel("kachhiLocalModel").setProperty("/kachhiData",a);t.byId("idSaveIcon").setColor("green");t.byId("idTransferButton").setEnabled(true);t.getTotals()}else{t.createModel();t.clearHeaderTotal();t.byId("idSaveIcon").setColor("green");t.byId("idTransferButton").setEnabled(false);sap.m.MessageToast.show(t.resourceBundle.getText("Screen16"))}}).catch(function(e){});this.getView().setBusy(false)},onConfirm:function(e){debugger;var t=this;var a=this.getView().getModel("local").getProperty("/kacchiData");a.Customer=e.getParameter("selectedItem").getBindingContextPath().split("'")[1];this.customerId=a.Customer;this.getView().getModel("local").setProperty("/kacchiData",a);var r=e.getParameter("selectedItem").getLabel();var i=e.getParameter("selectedItem").getValue();if(r){var o=this.getView().getModel("local").getProperty("/kachhiHeaderTemp");o.CustomerId=r;o.CustomerName=i;this.getView().getModel("local").setProperty("/kachhiHeaderTemp",o);this.getView().byId("idCustNo").setValueState()}var s=new sap.ui.model.Filter("Customer","EQ","'"+a.Customer+"'");this.getCustDataFromDB(s);var l=e.getParameter("selectedItem").getModel().getProperty(e.getParameter("selectedItem").getBindingContext().getPath());var t=this;var a=this.getView().getModel("local").getProperty("/kacchiData");var r=e.getParameter("selectedItem").getLabel();var i=e.getParameter("selectedItem").getValue();this.getView().byId("idCustNo").setValue(r);this.getView().getModel("local").setProperty("/kacchiData/Customer",e.getParameter("selectedItem").getBindingContextPath().split("'")[1]);this.getView().getModel("local").setProperty("/kachhiHeaderTemp/customerId",r);var s=new sap.ui.model.Filter("Customer","EQ","'"+a.Customer+"'");this.getCustDataFromDB(s)},onEnter:function(e){debugger;this.getCustomer(e);this.getView().byId("idTotalFine").focus();this.getView().byId("idTotalFine").$().find("input").select()}})});