sap.ui.define(["victoria/controller/BaseController","sap/ui/model/Filter","victoria/models/formatter","sap/ui/core/util/Export","sap/ui/core/util/ExportTypeCSV"],function(e,t,a,i,r){"use strict";return e.extend("victoria.controller.StockItems",{formatter:a,ZFilterr:[],mItems:[],cid:"",Qtty:0,onInit:function(){var e=this;var t=this.getModel("local").getProperty("/CurrentUser");var a=this.getModel("local").oData.AppUsers[t].UserName;a="Hey "+a;this.getView().byId("idUser").setText(a);debugger;this.byId("idOrderNo").setFilterFunction(function(e,t){return t.getText().match(new RegExp(e,"i"))});this.resourceBundle=this.getOwnerComponent().getModel("i18n").getResourceBundle()},onAfterRendering:function(){debugger;this.oRouter=sap.ui.core.UIComponent.getRouterFor(this);this.oRouter.attachRoutePatternMatched(this.herculis,this)},herculis:function(e){debugger;var t=[];var a=null;var i=null;var r=this;debugger;var s=this.getView().byId("idTable1");var l=this.getView().getModel();s.setModel(l);var o=s.getModel();this.getView().byId("idQ").setText("");this.getView().byId("idW").setText("");this.getView().byId("idOrderNo").setValue("");this.getView().byId("idMatCode").setValue("");this.getView().byId("idQuantity").setValue("");this.getView().byId("idWeight").setValue("");this.getView().byId("idRemarks").setValue("");this.getView().byId("matName").setText("");this.getView().byId("idTable1").getBinding("items").refresh(true);this.getView().byId("idDate").setDateValue(new Date);var d=this.byId("idDate").getValue();var g=new Date(d);g.setHours(0,0,0,1);var n=new Date(d);n.setHours(23,59,59,59);var a=new sap.ui.model.Filter("Date",sap.ui.model.FilterOperator.GE,g);var i=new sap.ui.model.Filter("Date",sap.ui.model.FilterOperator.LE,n);var t=new sap.ui.model.Filter({filters:[a,i],and:true})},valueHelpOrder:function(e){this.orderPopup(e)},onPayDateChange:function(e){debugger;var a=e.getSource().getProperty("dateValue");a.setHours(0,0,0,1);var i=new Date(a);i.setHours(23,59,59,59);var r=[];var s=null;var l=null;s=new t([new sap.ui.model.Filter("Date",sap.ui.model.FilterOperator.BT,a,i)],true);r=new sap.ui.model.Filter({filters:[s],and:true});this.getView().byId("idTable1").getBinding("items").filter(r,true)},decimalvalidator:function(e){debugger;if(e.getSource().getValue()<=0){debugger;e.getSource().setValueState(sap.ui.core.ValueState.Error)}else{e.getSource().setValueState(sap.ui.core.ValueState.None)}if(e.mParameters.id==="__component0---idStockItems--idWeight"){$(function(){$("input").on("input.idWeight",function(e){if(e.currentTarget.id=="__component0---idStockItems--idWeight-inner"){debugger;this.value=this.value.match(/^[+-]?\d{0,6}(\.\d{0,3})?/)[0]}})})}},onConfirm:function(e){debugger;var t=null;var a=[];var i=[];var r=null;var s=null;var l=null;var o=this;var d=e.getParameter("selectedItem").getProperty("label");this.getView().byId("idOrderNo").setValue(d);if(d){var g=e.getParameter("selectedItem").getBindingContextPath().split("/")[2];var n=null;if(g){n=parseInt(g)}}var t=new sap.ui.model.Filter("OrderNo",sap.ui.model.FilterOperator.EQ,d);var u=this.byId("idDate").getValue();var c=new Date(u);c.setHours(0,0,0,1);var p=new Date(u);p.setHours(23,59,59,59);var r=new sap.ui.model.Filter("Date",sap.ui.model.FilterOperator.GE,c);var s=new sap.ui.model.Filter("Date",sap.ui.model.FilterOperator.LE,p);var a=new sap.ui.model.Filter({filters:[t],and:true});this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/StockItems","GET",{filters:[a]},{},this).then(function(e){debugger;var t=e.results;var a=new sap.ui.model.json.JSONModel;a.setData({StockItems:t});var i=o.getView().byId("idTable1");i.setModel(a)}).catch(function(e){});var l=new sap.ui.model.Filter("OrderNo",sap.ui.model.FilterOperator.EQ,d);var i=new sap.ui.model.Filter({filters:[r,s,l],and:true});this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/OrderHeaders","GET",{filters:[i]},{},this).then(function(e){debugger;var t=e.results.slice();o.cid=e.results[0].id}).catch(function(e){console.log(e)});this.getView().byId("idQuantity").focus();this.getView().byId("idQuantity").$().find("input").select()},onMaterialSelect:function(e){debugger;var t=this;var a=null;var i=[];var r=null;var s=null;var l=null;var o=e.getParameter("selectedItem").getModel().getProperty(e.getParameter("selectedItem").getBindingContext().getPath());this.getView().getModel("local").setProperty("/StockItemsData/Material",o.id);console.log(o);var d=t.getView().getModel("local").getProperty("/StockItemsData/OrderNo");console.log(d);if(o.HindiName){this.getView().byId("matName").setText(o.HindiName)}else{this.getView().byId("matName").setText(o.ProductName)}var a=new sap.ui.model.Filter("OrderNo",sap.ui.model.FilterOperator.EQ,"'"+d+"'");var g=this.byId("idDate").getValue();var n=new Date(g);n.setHours(0,0,0,1);var u=new Date(g);u.setHours(23,59,59,59);var r=new sap.ui.model.Filter("Date",sap.ui.model.FilterOperator.GE,n);var s=new sap.ui.model.Filter("Date",sap.ui.model.FilterOperator.LE,u);var l=new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.Contains,o.id);var i=new sap.ui.model.Filter({filters:[r,s,a,l],and:true});this.ZFilterr=new sap.ui.model.Filter({filters:[r,s,a,l],and:true});this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/StockItems","GET",{filters:[i]},{},this).then(function(e){debugger;var a=e.results;console.log(a);var i=a.map(e=>e.Qty);var r=i.reduce((e,t)=>e+t,0);var s=a.map(e=>e.Weight);var l=s.reduce((e,t)=>e+t,0);var d=t.allMasterData;console.log(r);console.log(l);t.getView().byId("idQ").setText(parseFloat(r.toFixed(0)));t.getView().byId("idW").setText(parseFloat(l.toFixed(3)));t.getView().byId("idQuantity").focus();var g=a.map(e=>{e.MaterialName=o.ProductCode;return e});var n=new sap.ui.model.json.JSONModel;n.setData({StockItems:a});var u=t.getView().byId("idTable1");u.setModel(n)}).catch(function(e){})},validateValue:function(e){debugger;var t=this;var a=[];var i=null;var r=null;var s=null;var l=null;var o=this.byId("idDate").getValue();var d=new Date(o);d.setHours(0,0,0,1);var g=new Date(o);g.setHours(23,59,59,59);var i=new sap.ui.model.Filter("Date",sap.ui.model.FilterOperator.GE,d);var r=new sap.ui.model.Filter("Date",sap.ui.model.FilterOperator.LE,g);var l=new sap.ui.model.Filter("OrderNo",sap.ui.model.FilterOperator.EQ,"'"+t.cid+"'");var a=new sap.ui.model.Filter({filters:[l],and:true});this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/OrderItems","GET",{filters:[a]},{},this).then(function(e){debugger;var a=e.results;var i=t.byId("idQuantity").getValue();for(var r=0;r<e.results.length;r++){t.Qtty=t.Qtty+e.results[r].Qty}var s=parseInt(t.Qtty)}).catch(function(e){console.log(e)});t.Qtty=0},onItemsReport:function(){debugger;var e=this.getView().byId("idDate").getValue();window.open("/ItemsReport?date="+e)},onDailyReport:function(){var e=this.getView().byId("idDate").getValue();window.open("/DailyReport?date="+e)},onStockReport:function(){var e=this.getView().byId("idDate").getValue();window.open("/StockReport?date="+e)},onExportPdf:function(e){var t=this.getView().byId("idTable1");var a=t.getBinding("items");var s=new i({exportType:new r({separatorChar:"\t",mimeType:"application/vnd.ms-excel",charset:"utf-8",fileExtension:"xls"}),models:this.getView().getModel(),rows:{path:"/StockItems",filters:this.ZFilterr,parameters:{expand:"Material"}},columns:[{name:"Date",template:{content:"{Date}"}},{name:"Order Number",template:{content:"{OrderNo}"}},{name:"Material",template:{content:"{Material/ProductName}"}},{name:"Quantity",template:{content:"{Qty}"}},{name:"Weight",template:{content:"{Weight}"}},{name:"Created By",template:{content:"{CreatedBy}"}},{name:"Remarks",template:{content:"{Remarks}"}}]});s.saveFile().always(function(){this.destroy()})},refreshModel1:function(e){debugger;var t=this;var a=null;var i=[];var r=null;var s=null;var l=null;var o=e.getSource();if(e.getParameter("value")){var d=e.getParameter("value").toLocaleUpperCase();var g=o.getBinding("suggestionItems").aLastContextData;var n=g.find(e=>{if(JSON.parse(e).ProductCode===d){return g}});var u=JSON.parse(n);this.getView().getModel("local").setProperty("/StockItemsData/Material",u.id);if(u.HindiName){this.getView().byId("matName").setText(u.HindiName)}else{this.getView().byId("matName").setText(u.ProductName)}}var c=t.getView().getModel("local").getProperty("/StockItemsData/OrderNo");var a=new sap.ui.model.Filter("OrderNo",sap.ui.model.FilterOperator.EQ,"'"+c+"'");var p=this.byId("idDate").getValue();var m=new Date(p);m.setHours(0,0,0,1);var h=new Date(p);h.setHours(23,59,59,59);var r=new sap.ui.model.Filter("Date",sap.ui.model.FilterOperator.GE,m);var s=new sap.ui.model.Filter("Date",sap.ui.model.FilterOperator.LE,h);var l=new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.Contains,u.id);var i=new sap.ui.model.Filter({filters:[r,s,a,l],and:true});this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/StockItems","GET",{filters:[i]},{},this).then(function(e){debugger;var a=e.results;var i=a.map(e=>e.Qty);var r=i.reduce((e,t)=>e+t,0);var s=a.map(e=>e.Weight);var l=s.reduce((e,t)=>e+t,0);var o=t.allMasterData;console.log(o);t.getView().byId("idQ").setText(parseFloat(r.toFixed(0)));t.getView().byId("idW").setText(parseFloat(l.toFixed(3)));var d=a.map(e=>{e.MaterialName=u.ProductCode;return e});var g=new sap.ui.model.json.JSONModel;g.setData({StockItems:a});var n=t.getView().byId("idTable1");n.setModel(g)}).catch(function(e){});this.getView().byId("idQuantity").focus();this.getView().byId("idQuantity").$().find("input").select()},refreshModel:function(e){var t=[];var a=null;var i=null;var r=this;debugger;var s=this.getView().byId("idTable1");var l=e.getParameter("value");var o=e.getSource();o.setValue(o.getValue().toUpperCase());if(l==""){var d=this.getView().getModel();s.setModel(d);this.getView().byId("idQ").setText("");this.getView().byId("idW").setText("");this.getView().byId("matName").setText("")}},orderPopup:function(e){debugger;var t=this;this.orderNoPopup=new sap.ui.xmlfragment("victoria.fragments.popup",this);this.getView().addDependent(this.orderNoPopup);var a=this.getView().getModel("i18n").getProperty("orderSearch");this.orderNoPopup.setTitle(a);var i=this.byId("idDate").getValue();var r=new Date(i);r.setHours(0,0,0,1);var s=new Date(i);s.setHours(23,59,59,59);var l=new sap.ui.model.Filter("Date",sap.ui.model.FilterOperator.GE,r);var o=new sap.ui.model.Filter("Date",sap.ui.model.FilterOperator.LE,s);debugger;var d=new sap.ui.model.Filter({filters:[l,o],and:true});this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/OrderHeaders","GET",{},{},this).then(function(e){debugger;var a=e.results.slice();t.ODataHelper.callOData(t.getOwnerComponent().getModel(),"/WSOrderHeaders","GET",{},{},t).then(function(e){debugger;var i=e.results.slice();var r=a.concat(i);var s=new sap.ui.model.json.JSONModel;s.setData({items:r});t.getView().setModel(s,"temp")}).catch(function(e){console.log(e)})}).catch(function(e){console.log(e)});this.orderNoPopup.bindAggregation("items",{path:"/StockItems",template:new sap.m.DisplayListItem({label:"{OrderNo}"}),sorter:new sap.ui.model.Sorter("OrderNo")});this.orderNoPopup.open()},onSend:function(e){debugger;var t=this;var a=this.getView().byId("idQuantity").getValue();var i=this.getView().byId("idWeight").getValue();var r=this.getView().byId("idOrderNo").getValue();var s=a-a*2;var l=i-i*2;this.getView().getModel("local").setProperty("/StockItemsData/Qty",s);this.getView().getModel("local").setProperty("/StockItemsData/Weight",l);this.getView().getModel("local").setProperty("/StockItemsData/OrderNo",r);var o=this.getView().getModel("local").getProperty("/StockItemsData");console.log(o);if(this.getView().byId("idMatCode").getValue()===""){sap.m.MessageBox.show("Please enter the Material");this.getView().getModel("local").setProperty("/StockItemsData/Qty",a);this.getView().getModel("local").setProperty("/StockItemsData/Weight",i)}else if(this.getView().byId("idQuantity").getValue()==="0"){sap.m.MessageBox.show("Please enter quantity");return}else if(this.getView().byId("idMatCode").getValue()){debugger;var d=this.getView().byId("idMatCode").getValue();var g=new sap.ui.model.Filter("ProductCode",sap.ui.model.FilterOperator.EQ,d);this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Products","GET",{filters:[g]},{},this).then(function(e){debugger;t.mItems=e.results;if(t.mItems.length==0){sap.m.MessageBox.show("Please select the valid Material");t.getView().getModel("local").setProperty("/StockItemsData/Qty",a);t.getView().getModel("local").setProperty("/StockItemsData/Weight",i)}else{t.ODataHelper.callOData(t.getOwnerComponent().getModel(),"/StockItems","POST",{},o,t).then(function(e){t.getView().setBusy(false);debugger;sap.m.MessageToast.show("Data Saved Successfully");if(t.getView().byId("CBID").getSelected()){t.getView().byId("idMatCode").setValue("");t.getView().byId("idQuantity").setValue("");t.getView().byId("idWeight").setValue("");t.getView().byId("idRemarks").setValue("");t.getView().byId("idQ").setText("");t.getView().byId("idW").setText("");t.getView().byId("matName").setText("");jQuery.sap.delayedCall(0,this,function(){t.getView().byId("idMatCode").focus()})}else{t.getView().byId("idOrderNo").setValue("");t.getView().byId("idMatCode").setValue("");t.getView().byId("idQuantity").setValue("");t.getView().byId("idWeight").setValue("");t.getView().byId("idRemarks").setValue("");t.getView().byId("idQ").setText("");t.getView().byId("idW").setText("");t.getView().byId("matName").setText("");t.getView().getModel("local").setProperty("/StockItemsData/Order","");t.getView().getModel("local").setProperty("/StockItemsData/OrderNo","");t.getView().byId("idOrderNo").focus()}}).catch(function(e){t.getView().setBusy(false)})}}).catch(function(e){var a=t.getErrorMessage(e)})}var n=this.getView().byId("idTable1");var u=t.getView().getModel();n.setModel(u);var c=this.byId("idDate").getValue();var p=new Date(c);p.setHours(0,0,0,1);var m=new Date(c);m.setHours(23,59,59,59);var h=new sap.ui.model.Filter("Date",sap.ui.model.FilterOperator.GE,p);var v=new sap.ui.model.Filter("Date",sap.ui.model.FilterOperator.LE,m);var w=new sap.ui.model.Filter({filters:[h,v],and:true});n.getBinding("items").filter(w,true);t.getView().byId("idDelete").setEnabled(true)},onSelect:function(e){},onClear:function(){debugger;var e=this;e.getView().byId("idOrderNo").setValue("");e.getView().byId("idMatCode").setValue("");e.getView().byId("idQuantity").setValue("");e.getView().byId("idWeight").setValue("");e.getView().byId("idRemarks").setValue("");e.getView().byId("idQ").setText("");e.getView().byId("idW").setText("");e.getView().byId("matName").setText("");var t=e.getView().byId("idTable1");var a=e.getView().getModel();t.setModel(a);this.getView().byId("idDelete").setEnabled(true);this.byId("idDate").setDateValue(new Date);this.getView().byId("idTable1").getBinding("items").filter([])},onDelete:function(){var e=this;sap.m.MessageBox.confirm("Deleting Selected Records",{title:"Confirm",actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],styleClass:"",onClose:function(t){debugger;if(t==="OK"){debugger;var a=e.getView().byId("idTable1");var i=a.getSelectedItems();if(i.length){for(var r=0;r<i.length;r++){debugger;var s=i[r].getBindingContext().sPath;e.ODataHelper.callOData(e.getOwnerComponent().getModel(),s,"DELETE",{},{},e);a.getModel().refresh(true)}}sap.m.MessageToast.show("Selected records are deleted");var l=e.getView().byId("idTable1");var o=e.getView().getModel();l.setModel(o)}}})},onUpdateFinished:function(e){debugger;var t=e.getSource();var a=t.getItems();var i=a.length;var r=this.getView().getModel("i18n").getProperty("allEntries");this.getView().byId("idTitle").setText(r+" "+"("+i+")");var s=0;var l=0;for(var o=0;o<i;o++){debugger;var d=t.getItems()[o].getCells()[2].getText();var g=t.getItems()[o].getCells()[1].getText();var n=t.getItems()[o].getCells()[5].getText();s+=parseFloat(t.getItems()[o].getCells()[4].getText());l+=parseInt(t.getItems()[o].getCells()[3].getText());var u=this.allMasterData.orderHeader[g];var c=this.allMasterData.wholeSaleHeader[g];var p=this.allMasterData.materials[d];var m=this.allMasterData.users[n];try{if(p){t.getItems()[o].getCells()[2].setText(p.ProductCode)}}catch(e){}try{if(u){t.getItems()[o].getCells()[1].setText(u.OrderNo)}}catch(e){}try{if(c){t.getItems()[o].getCells()[1].setText(c.OrderNo)}}catch(e){}try{if(m){t.getItems()[o].getCells()[5].setText(m.UserName)}}catch(e){}}this.getView().byId("idQ").setText(l);this.getView().byId("idQ").setState(l<0?"Error":"Success");this.getView().byId("idW").setText(s);this.getView().byId("idW").setState(s<0?"Error":"Success")},onSubmitQuantity:function(e){this.getView().byId("idWeight").focus();this.getView().byId("idWeight").$().find("input").select()},onSubmitWeight:function(e){this.getView().byId("idRemarks").focus();this.getView().byId("idRemarks").$().find("input").select()},onSubmitRemarks:function(e){this.getView().byId("idSend").focus()},onSubmitOrderNo:function(e){debugger;this.getView().byId("idQuantity").focus();this.getView().byId("idQuantity").$().find("input").select();var t=this.getView().byId("idOrderNo").getValue();var a=new sap.ui.model.Filter("OrderNo",sap.ui.model.FilterOperator.EQ,t);var i=new sap.ui.model.Filter({filters:[a],and:true});this.getView().byId("idTable1").getBinding("items").filter(i,true)},_getDialog:function(e){debugger;if(!this.oDialog){this.oDialog=sap.ui.xmlfragment("stockDialog","victoria.fragments.stockDialog",this);this.getView().addDependent(this.oDialog)}this.oDialog.open();var t=this.getView().byId("idTable1").getSelectedItem().getCells()[1].getText();sap.ui.getCore().byId("stockDialog--idDialog-title").setText(t);var a=this.getView().byId("idTable1").getSelectedItem().mAggregations.cells[0].mProperties.text;sap.ui.getCore().byId("stockDialog--idDialogDate").setValue(a);var i=this.getView().byId("idTable1").getSelectedItem().mAggregations.cells[2].mProperties.text;sap.ui.getCore().byId("stockDialog--idDialogNo").setValue(i);var r=this.getView().byId("idTable1").getSelectedItem().mAggregations.cells[3].mProperties.text;var s=parseFloat(r);sap.ui.getCore().byId("stockDialog--idDialogQty").setValue(r);var l=this.getView().byId("idTable1").getSelectedItem().mAggregations.cells[4].mProperties.text;var o=parseFloat(l);sap.ui.getCore().byId("stockDialog--idDialogWeight").setValue(l);var d=this.getView().byId("idTable1").getSelectedItem().mAggregations.cells[6].mProperties.text;sap.ui.getCore().byId("stockDialog--idDialogRem").setValue(d)},onPressHandleEntrySavePopup:function(e){debugger;var t=this;t.getView().setBusy(true);var a=this.getView().getModel("local").getProperty("/StockItemsData");a.Date=sap.ui.getCore().byId("stockDialog--idDialogDate").getValue();a.Qty=sap.ui.getCore().byId("stockDialog--idDialogQty").getValue();a.Weight=sap.ui.getCore().byId("stockDialog--idDialogWeight").getValue();a.Remarks=sap.ui.getCore().byId("stockDialog--idDialogRem").getValue();var i=this.getView().byId("idTable1").getSelectedContextPaths()[0].split("'")[1];this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/StockItems('"+i+"')","PUT",{},a,this).then(function(e){t.getView().setBusy(false);sap.m.MessageToast.show(t.resourceBundle.getText("Update111"));t.oDialog.close()}).catch(function(e){t.getView().setBusy(false);var a=t.getErrorMessage(e)});var r=sap.ui.getCore().byId("stockDialog--idDialogQty").getValue();var s=parseFloat(sap.ui.getCore().byId("stockDialog--idDialogQty").getValue());var l=sap.ui.getCore().byId("stockDialog--idDialogWeight").getValue();var o=parseFloat(sap.ui.getCore().byId("stockDialog--idDialogWeight").getValue());var d=this.getView().byId("idTable1").getItems();var g=d.length;var n=0;var u=0;var c=0;if(d.length){for(var p=0;p<d.length;p++){var m=d[p].getBindingContext().getObject().Weight;if(m){n+=n+m-n}}}var h=n-parseFloat(this.getView().byId("idTable1").getSelectedItem().getCells()[5].getText());var v=h;v.toFixed(2);parseFloat(v.toFixed(2));var d=this.getView().byId("idTable1").getItems();var g=d.length;var n=0;var u=0;var c=0;if(d.length){for(var p=0;p<d.length;p++){var w=d[p].getBindingContext().getObject().Qty;if(w){u+=u+w-u}}}var y=u-parseFloat(this.getView().byId("idTable1").getSelectedItem().getCells()[4].getText());var v=y;v.toFixed(2);parseFloat(v.toFixed(2));this.oDialog.close()},onPressHandleEntryCancelPopup:function(){this.oDialog.close()},onEdit:function(e){debugger;var t=this;var a=this.getView().byId("idTable1").getSelectedItems().length;if(a>1){sap.m.MessageBox.alert(t.resourceBundle.getText("Selectoneentryonly"))}else if(a===0){sap.m.MessageBox.alert(t.resourceBundle.getText("Selectoneentryonly1"))}else{this._getDialog()}}})});