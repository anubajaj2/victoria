sap.ui.define(["victoria/controller/BaseController","sap/ui/model/Filter","victoria/models/formatter","sap/ui/core/util/Export","sap/ui/core/util/ExportTypeCSV"],function(e,t,a,r,i){"use strict";return e.extend("victoria.controller.StockItems",{formatter:a,ZFilterr:[],mItems:[],cid:"",Qtty:0,onInit:function(){var e=this;var t=this.getModel("local").getProperty("/CurrentUser");var a=this.getModel("local").oData.AppUsers[t].UserName;a="Hey "+a;this.getView().byId("idUser").setText(a);debugger},onAfterRendering:function(){debugger;this.oRouter=sap.ui.core.UIComponent.getRouterFor(this);this.oRouter.attachRoutePatternMatched(this.herculis,this)},herculis:function(e){debugger;var t=[];var a=null;var r=null;var i=this;debugger;var s=this.getView().byId("idTable1");var l=this.getView().getModel();s.setModel(l);var o=s.getModel();this.getView().byId("idQ").setText("");this.getView().byId("idW").setText("");this.getView().byId("idOrderNo").setValue("");this.getView().byId("idMatCode").setValue("");this.getView().byId("idQuantity").setValue("");this.getView().byId("idWeight").setValue("");this.getView().byId("idRemarks").setValue("");this.getView().byId("matName").setText("");this.getView().byId("idTable1").getBinding("items").refresh(true);this.getView().byId("idDate").setDateValue(new Date);var d=this.byId("idDate").getValue();var n=new Date(d);n.setHours(0,0,0,1);var g=new Date(d);g.setHours(23,59,59,59);var a=new sap.ui.model.Filter("Date",sap.ui.model.FilterOperator.GE,n);var r=new sap.ui.model.Filter("Date",sap.ui.model.FilterOperator.LE,g);var t=new sap.ui.model.Filter({filters:[a,r],and:true});this.getView().byId("idTable1").getBinding("items").filter(t,true)},valueHelpOrder:function(e){this.orderPopup(e)},onPayDateChange:function(e){debugger;var a=e.getSource().getProperty("dateValue");a.setHours(0,0,0,1);var r=new Date(a);r.setHours(23,59,59,59);var i=[];var s=null;var l=null;s=new t([new sap.ui.model.Filter("Date",sap.ui.model.FilterOperator.BT,a,r)],true);i=new sap.ui.model.Filter({filters:[s],and:true});this.getView().byId("idTable1").getBinding("items").filter(i,true)},decimalvalidator:function(e){debugger;if(e.getSource().getValue()<=0){debugger;e.getSource().setValueState(sap.ui.core.ValueState.Error);dialogSave.setEnabled(false)}else{e.getSource().setValueState(sap.ui.core.ValueState.None);dialogSave.setEnabled(true)}if(e.mParameters.id==="__component0---idStockItems--idWeight"){$(function(){$("input").on("input.idWeight",function(e){if(e.currentTarget.id=="__component0---idStockItems--idWeight-inner"){debugger;this.value=this.value.match(/^[+-]?\d{0,6}(\.\d{0,3})?/)[0]}})})}},onConfirm:function(e){debugger;var t=null;var a=[];var r=[];var i=null;var s=null;var l=null;var o=this;var d=e.getParameter("selectedItem");if(d){var n=d.getLabel();var g=parseInt(n);this.getView().getModel("local").setProperty("/StockItemsData/Order",n);var u=e.getParameter("selectedItem").getBindingContextPath().split("/")[2];var m=null;if(u){m=parseInt(u)}this.getView().getModel("local").setProperty("/StockItemsData/OrderNo",o.getView().getModel("temp").oData.items[m].id)}var c=this.getView().getModel("temp").oData.items[m].id;var p=c.toString();var t=new sap.ui.model.Filter("OrderNo",sap.ui.model.FilterOperator.EQ,"'"+p+"'");var v=this.byId("idDate").getValue();var h=new Date(v);h.setHours(0,0,0,1);var w=new Date(v);w.setHours(23,59,59,59);var i=new sap.ui.model.Filter("Date",sap.ui.model.FilterOperator.GE,h);var s=new sap.ui.model.Filter("Date",sap.ui.model.FilterOperator.LE,w);var a=new sap.ui.model.Filter({filters:[i,s,t],and:true});this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/StockItems","GET",{filters:[a]},{},this).then(function(e){debugger;var t=e.results;var a=new sap.ui.model.json.JSONModel;a.setData({StockItems:t});var r=o.getView().byId("idTable1");r.setModel(a)}).catch(function(e){});var l=new sap.ui.model.Filter("OrderNo",sap.ui.model.FilterOperator.EQ,n);var r=new sap.ui.model.Filter({filters:[i,s,l],and:true});this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/OrderHeaders","GET",{filters:[r]},{},this).then(function(e){debugger;var t=e.results.slice();o.cid=e.results[0].id}).catch(function(e){console.log(e)})},onMaterialSelect:function(e){debugger;var t=this;var a=null;var r=[];var i=null;var s=null;var l=null;var o=e.getParameter("selectedItem").getModel().getProperty(e.getParameter("selectedItem").getBindingContext().getPath());this.getView().getModel("local").setProperty("/StockItemsData/Material",o.id);console.log(o);var d=t.getView().getModel("local").getProperty("/StockItemsData/OrderNo");console.log(d);if(o.HindiName){this.getView().byId("matName").setText(o.HindiName)}else{this.getView().byId("matName").setText(o.ProductName)}var a=new sap.ui.model.Filter("OrderNo",sap.ui.model.FilterOperator.EQ,"'"+d+"'");var n=this.byId("idDate").getValue();var g=new Date(n);g.setHours(0,0,0,1);var u=new Date(n);u.setHours(23,59,59,59);var i=new sap.ui.model.Filter("Date",sap.ui.model.FilterOperator.GE,g);var s=new sap.ui.model.Filter("Date",sap.ui.model.FilterOperator.LE,u);var l=new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.Contains,o.id);var r=new sap.ui.model.Filter({filters:[i,s,a,l],and:true});this.ZFilterr=new sap.ui.model.Filter({filters:[i,s,a,l],and:true});this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/StockItems","GET",{filters:[r]},{},this).then(function(e){debugger;var a=e.results;console.log(a);var r=a.map(e=>e.Qty);var i=r.reduce((e,t)=>e+t,0);var s=a.map(e=>e.Weight);var l=s.reduce((e,t)=>e+t,0);var d=t.allMasterData;console.log(i);console.log(l);t.getView().byId("idQ").setText(parseFloat(i.toFixed(0)));t.getView().byId("idW").setText(parseFloat(l.toFixed(3)));t.getView().byId("idQuantity").focus();var n=a.map(e=>{e.MaterialName=o.ProductCode;return e});var g=new sap.ui.model.json.JSONModel;g.setData({StockItems:a});var u=t.getView().byId("idTable1");u.setModel(g)}).catch(function(e){})},validateValue:function(e){debugger;var t=this;var a=[];var r=null;var i=null;var s=null;var l=null;var o=this.byId("idDate").getValue();var d=new Date(o);d.setHours(0,0,0,1);var n=new Date(o);n.setHours(23,59,59,59);var r=new sap.ui.model.Filter("Date",sap.ui.model.FilterOperator.GE,d);var i=new sap.ui.model.Filter("Date",sap.ui.model.FilterOperator.LE,n);var l=new sap.ui.model.Filter("OrderNo",sap.ui.model.FilterOperator.EQ,"'"+t.cid+"'");var a=new sap.ui.model.Filter({filters:[l],and:true});this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/OrderItems","GET",{filters:[a]},{},this).then(function(e){debugger;var a=e.results;var r=t.byId("idQuantity").getValue();for(var i=0;i<e.results.length;i++){t.Qtty=t.Qtty+e.results[i].Qty}var s=parseInt(t.Qtty)}).catch(function(e){console.log(e)});t.Qtty=0},onItemsReport:function(){debugger;var e=this.getView().byId("idDate").getValue();window.open("/ItemsReport?date="+e)},onDailyReport:function(){var e=this.getView().byId("idDate").getValue();window.open("/DailyReport?date="+e)},onStockReport:function(){var e=this.getView().byId("idDate").getValue();window.open("/StockReport?date="+e)},onExportPdf:function(e){var t=this.getView().byId("idTable1");var a=t.getBinding("items");var s=new r({exportType:new i({separatorChar:"\t",mimeType:"application/vnd.ms-excel",charset:"utf-8",fileExtension:"xls"}),models:this.getView().getModel(),rows:{path:"/StockItems",filters:this.ZFilterr,parameters:{expand:"Material"}},columns:[{name:"Date",template:{content:"{Date}"}},{name:"Order Number",template:{content:"{OrderNo}"}},{name:"Material",template:{content:"{Material/ProductName}"}},{name:"Quantity",template:{content:"{Qty}"}},{name:"Weight",template:{content:"{Weight}"}},{name:"Created By",template:{content:"{CreatedBy}"}},{name:"Remarks",template:{content:"{Remarks}"}}]});s.saveFile().always(function(){this.destroy()})},refreshModel1:function(e){debugger;var t=this;var a=null;var r=[];var i=null;var s=null;var l=null;var o=e.getSource();if(e.getParameter("value")){var d=e.getParameter("value").toLocaleUpperCase();var n=o.getBinding("suggestionItems").aLastContextData;var g=n.find(e=>{if(JSON.parse(e).ProductCode===d){return n}});var u=JSON.parse(g);this.getView().getModel("local").setProperty("/StockItemsData/Material",u.id);if(u.HindiName){this.getView().byId("matName").setText(u.HindiName)}else{this.getView().byId("matName").setText(u.ProductName)}}var m=t.getView().getModel("local").getProperty("/StockItemsData/OrderNo");var a=new sap.ui.model.Filter("OrderNo",sap.ui.model.FilterOperator.EQ,"'"+m+"'");var c=this.byId("idDate").getValue();var p=new Date(c);p.setHours(0,0,0,1);var v=new Date(c);v.setHours(23,59,59,59);var i=new sap.ui.model.Filter("Date",sap.ui.model.FilterOperator.GE,p);var s=new sap.ui.model.Filter("Date",sap.ui.model.FilterOperator.LE,v);var l=new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.Contains,u.id);var r=new sap.ui.model.Filter({filters:[i,s,a,l],and:true});this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/StockItems","GET",{filters:[r]},{},this).then(function(e){debugger;var a=e.results;var r=a.map(e=>e.Qty);var i=r.reduce((e,t)=>e+t,0);var s=a.map(e=>e.Weight);var l=s.reduce((e,t)=>e+t,0);var o=t.allMasterData;console.log(o);t.getView().byId("idQ").setText(parseFloat(i.toFixed(0)));t.getView().byId("idW").setText(parseFloat(l.toFixed(3)));var d=a.map(e=>{e.MaterialName=u.ProductCode;return e});var n=new sap.ui.model.json.JSONModel;n.setData({StockItems:a});var g=t.getView().byId("idTable1");g.setModel(n)}).catch(function(e){});this.getView().byId("idQuantity").focus();this.getView().byId("idQuantity").$().find("input").select()},refreshModel:function(e){var t=[];var a=null;var r=null;var i=this;debugger;var s=this.getView().byId("idTable1");var l=e.getParameter("value");var o=e.getSource();o.setValue(o.getValue().toUpperCase());if(l==""){var d=this.getView().getModel();s.setModel(d);this.getView().byId("idQ").setText("");this.getView().byId("idW").setText("");this.getView().byId("matName").setText("")}},orderPopup:function(e){var t=this;this.orderNoPopup=new sap.ui.xmlfragment("victoria.fragments.popup",this);this.getView().addDependent(this.orderNoPopup);var a=this.getView().getModel("i18n").getProperty("orderSearch");this.orderNoPopup.setTitle(a);var r=this.byId("idDate").getValue();var i=new Date(r);i.setHours(0,0,0,1);var s=new Date(r);s.setHours(23,59,59,59);var l=new sap.ui.model.Filter("Date",sap.ui.model.FilterOperator.GE,i);var o=new sap.ui.model.Filter("Date",sap.ui.model.FilterOperator.LE,s);debugger;var d=new sap.ui.model.Filter({filters:[l,o],and:true});this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/OrderHeaders","GET",{filters:[d]},{},this).then(function(e){debugger;var a=e.results.slice();t.ODataHelper.callOData(t.getOwnerComponent().getModel(),"/WSOrderHeaders","GET",{filters:[d]},{},t).then(function(e){debugger;var r=e.results.slice();var i=a.concat(r);var s=new sap.ui.model.json.JSONModel;s.setData({items:i});t.getView().setModel(s,"temp")}).catch(function(e){console.log(e)})}).catch(function(e){console.log(e)});this.orderNoPopup.bindAggregation("items",{path:"temp>/items",filters:d,template:new sap.m.DisplayListItem({label:"{temp>OrderNo}",value:{path:"temp>Customer",formatter:this.getCustomerName.bind(this)}})});this.orderNoPopup.open()},onSend:function(e){debugger;var t=this;var a=this.getView().byId("idQuantity").getValue();var r=this.getView().byId("idWeight").getValue();var i=this.getView().byId("idOrderNo").getValue();var s=a-a*2;var l=r-r*2;this.getView().getModel("local").setProperty("/StockItemsData/Qty",s);this.getView().getModel("local").setProperty("/StockItemsData/Weight",l);this.getView().getModel("local").setProperty("/StockItemsData/OrderNo",i);var o=this.getView().getModel("local").getProperty("/StockItemsData");console.log(o);if(this.getView().byId("idMatCode").getValue()===""){sap.m.MessageBox.show("Please enter the Material");this.getView().getModel("local").setProperty("/StockItemsData/Qty",a);this.getView().getModel("local").setProperty("/StockItemsData/Weight",r)}else if(this.getView().byId("idQuantity").getValue()==="0"){sap.m.MessageBox.show("Please enter quantity");return}else if(this.getView().byId("idMatCode").getValue()){debugger;var d=this.getView().byId("idMatCode").getValue();var n=new sap.ui.model.Filter("ProductCode",sap.ui.model.FilterOperator.EQ,d);this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Products","GET",{filters:[n]},{},this).then(function(e){debugger;t.mItems=e.results;if(t.mItems.length==0){sap.m.MessageBox.show("Please select the valid Material");t.getView().getModel("local").setProperty("/StockItemsData/Qty",a);t.getView().getModel("local").setProperty("/StockItemsData/Weight",r)}else{t.ODataHelper.callOData(t.getOwnerComponent().getModel(),"/StockItems","POST",{},o,t).then(function(e){t.getView().setBusy(false);debugger;sap.m.MessageToast.show("Data Saved Successfully");if(t.getView().byId("CBID").getSelected()){t.getView().byId("idMatCode").setValue("");t.getView().byId("idQuantity").setValue("");t.getView().byId("idWeight").setValue("");t.getView().byId("idRemarks").setValue("");t.getView().byId("idQ").setText("");t.getView().byId("idW").setText("");t.getView().byId("matName").setText("");jQuery.sap.delayedCall(0,this,function(){t.getView().byId("idMatCode").focus()})}else{t.getView().byId("idOrderNo").setValue("");t.getView().byId("idMatCode").setValue("");t.getView().byId("idQuantity").setValue("");t.getView().byId("idWeight").setValue("");t.getView().byId("idRemarks").setValue("");t.getView().byId("idQ").setText("");t.getView().byId("idW").setText("");t.getView().byId("matName").setText("");t.getView().getModel("local").setProperty("/StockItemsData/Order","");t.getView().getModel("local").setProperty("/StockItemsData/OrderNo","");t.getView().byId("idOrderNo").focus()}}).catch(function(e){t.getView().setBusy(false)})}}).catch(function(e){var a=t.getErrorMessage(e)})}var g=this.getView().byId("idTable1");var u=t.getView().getModel();g.setModel(u);var m=this.byId("idDate").getValue();var c=new Date(m);c.setHours(0,0,0,1);var p=new Date(m);p.setHours(23,59,59,59);var v=new sap.ui.model.Filter("Date",sap.ui.model.FilterOperator.GE,c);var h=new sap.ui.model.Filter("Date",sap.ui.model.FilterOperator.LE,p);var w=new sap.ui.model.Filter({filters:[v,h],and:true});g.getBinding("items").filter(w,true);t.getView().byId("idDelete").setEnabled(true)},onSelect:function(e){},onClear:function(){var e=this;e.getView().byId("idOrderNo").setValue("");e.getView().byId("idMatCode").setValue("");e.getView().byId("idQuantity").setValue("");e.getView().byId("idWeight").setValue("");e.getView().byId("idRemarks").setValue("");e.getView().byId("idQ").setText("");e.getView().byId("idW").setText("");e.getView().byId("matName").setText("");var t=e.getView().byId("idTable1");var a=e.getView().getModel();t.setModel(a);this.getView().byId("idDelete").setEnabled(true)},onDelete:function(){var e=this;sap.m.MessageBox.confirm("Deleting Selected Records",{title:"Confirm",actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],styleClass:"",onClose:function(t){debugger;if(t==="OK"){debugger;var a=e.getView().byId("idTable1");var r=a.getSelectedItems();if(r.length){for(var i=0;i<r.length;i++){debugger;var s=r[i].getBindingContext().sPath;e.ODataHelper.callOData(e.getOwnerComponent().getModel(),s,"DELETE",{},{},e);a.getModel().refresh(true)}}sap.m.MessageToast.show("Selected records are deleted");var l=e.getView().byId("idTable1");var o=e.getView().getModel();l.setModel(o)}}})},onUpdateFinished:function(e){debugger;var t=e.getSource();var a=t.getItems();var r=a.length;var i=this.getView().getModel("i18n").getProperty("allEntries");this.getView().byId("idTitle").setText(i+" "+"("+r+")");var s=0;var l=0;for(var o=0;o<r;o++){debugger;var d=t.getItems()[o].getCells()[2].getText();var n=t.getItems()[o].getCells()[1].getText();var g=t.getItems()[o].getCells()[5].getText();s+=parseFloat(t.getItems()[o].getCells()[4].getText());l+=parseInt(t.getItems()[o].getCells()[3].getText());var u=this.allMasterData.orderHeader[n];var m=this.allMasterData.wholeSaleHeader[n];var c=this.allMasterData.materials[d];var p=this.allMasterData.users[g];try{if(c){t.getItems()[o].getCells()[2].setText(c.ProductCode)}}catch(e){}try{if(u){t.getItems()[o].getCells()[1].setText(u.OrderNo)}}catch(e){}try{if(m){t.getItems()[o].getCells()[1].setText(m.OrderNo)}}catch(e){}try{if(p){t.getItems()[o].getCells()[5].setText(p.UserName)}}catch(e){}}this.getView().byId("idQ").setText(l);this.getView().byId("idQ").setState(l<0?"Error":"Success");this.getView().byId("idW").setText(s)},onSubmitQuantity:function(e){this.getView().byId("idWeight").focus();this.getView().byId("idWeight").$().find("input").select()},onSubmitWeight:function(e){this.getView().byId("idRemarks").focus();this.getView().byId("idRemarks").$().find("input").select()},onSubmitRemarks:function(e){this.getView().byId("idSend").focus()},onSubmitOrderNo:function(e){this.getView().byId("idMatCode").focus();this.getView().byId("idMatCode").$().find("input").select()}})});