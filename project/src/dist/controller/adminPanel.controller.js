sap.ui.define(["victoria/controller/BaseController","sap/m/MessageBox","sap/m/MessageToast","victoria/models/formatter","sap/ui/model/json/JSONModel"],function(e,t,s,a,o){"use strict";return e.extend("victoria.controller.adminPanel",{formatter:a,onInit:function(){this.oRouter=sap.ui.core.UIComponent.getRouterFor(this);this.oRouter.attachRoutePatternMatched(this.herculis,this);var e=this;var t=this.getModel("local").getProperty("/CurrentUser");var s=this.getModel("local").oData.AppUsers[t].UserName;s="Hey "+s;this.getView().byId("idUser").setText(s);e.getView().setBusy(true);this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/AppUsers","GET",null,null,this).then(function(t){e.getView().setBusy(false)}).catch(function(t){var s=e.getErrorMessage(t)})},onPressSaveSecure:function(){var e=this;e.getView().byId("viewSecureTable").setBusy(true);var a=this.getView().getModel("local");var o=a.getData().appUsers;this.getView().getModel().setDeferredBatchGroups(["SaveSecureUserBatch"]);var r=function(e,t){return e.CredId===t.CredId};if(o.length>0){var i;for(var n=0;n<o.length;n++){delete o[n].CreateMode;if(o[n].SecureKey==="*******"){o[n].SecureKey=""}o[n].SecureKey=btoa(o[n].SecureKey);i=this.globalData.filter(r.bind(null,o[n]));if(i.length===1&&JSON.stringify(i[0])!==JSON.stringify(o[n])){this.getView().getModel().update("/SecureSet('"+o[n].CredId+"')",o[n],{groupId:"SaveSecureUserBatch"})}else if(o[n].CredId===undefined){this.getView().getModel().create("/SecureSet",o[n],{groupId:"SaveSecureUserBatch"})}}for(var l=0;l<this.globalData.length;l++){i=o.filter(r.bind(null,this.globalData[l]));if(i.length===0){this.getView().getModel().remove("/SecureSet('"+this.globalData[l].CredId+"')",{groupId:"SaveSecureUserBatch"})}}}else{for(var u=0;u<this.globalData.length;u++){this.getView().getModel().remove("/SecureSet('"+this.globalData[u].CredId+"')",{groupId:"SaveSecureUserBatch"})}}if(JSON.stringify(o)===JSON.stringify(this.globalData)){s.show(e.resourceBundle.getText("MSG_GET_SECURE_SAVE_ERROR"));e.getView().byId("viewSecureTable").setBusy(false);return}this.getView().getModel().submitChanges({batchGroupId:"SaveSecureUserBatch",success:function(a,o){var r=a.__batchResponses;e.getView().byId("viewSecureTable").setBusy(false);for(var i=0;i<r.length;i++){if(a.__batchResponses[i].response&&a.__batchResponses[i].response.statusCode>399&&a.__batchResponses[i].response.statusCode<600){t.error(JSON.parse(a.__batchResponses[i].response.body).error.message.value,{title:e.resourceBundle.getText("TIT_MESSAGE_BOX_ERR"),onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit});return}}e._getSecureDetails();s.show(e.resourceBundle.getText("MSG_GET_SECURE_SAVE_SUCCESS"))},error:function(s){e.getView().byId("viewSecureTable").setBusy(false);t.error(e.getErrorMsg(s),{title:e.resourceBundle.getText("TIT_MESSAGE_BOX_ERR"),onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit})}})},onPressDeleteSecureRow:function(){var e=this;var s=this.getView().byId("viewSecureTable").getSelectedContexts();var a=this.getView().getModel("local");var o=a.getData().appUsers;if(s.length<1){t.error("Select atlease one row",{title:"Selection Error",onClose:null,styleClass:"",initialFocus:null,textDirection:sap.ui.core.TextDirection.Inherit});return}sap.m.MessageBox.confirm("Confirm deletion?",{title:"Confirmation",onClose:function(t){if(t===sap.m.MessageBox.Action.OK){var s=e.getView().byId("viewSecureTable").getSelectedContexts();for(var o=0;o<s["length"];o++){e.ODataHelper.callOData(e.getOwnerComponent().getModel(),s[o].sPath,"DELETE",{},{},e).then(function(e){sap.m.MessageToast.show("Deleted succesfully")}).catch(function(t){e.getView().setBusy(false);e.oPopover=e.getErrorMessage(t);e.getView().setBusy(false)})}a.updateBindings();e.getView().byId("viewSecureTable").removeSelections()}}})},onPressHandleSecureOkPopup:function(e){var t=this;var a=e.getSource().getParent().getContent()[0].getBindingContext(),o=sap.ui.getCore().byId("Secure_Dialog--idPassword").getValue(),r=sap.ui.getCore().byId("Secure_Dialog--idConfirmPassword").getValue();if(o!==r){s.show("Password not matched");return}var i={Role:sap.ui.getCore().byId("Secure_Dialog--idRole").getValue(),UserName:sap.ui.getCore().byId("Secure_Dialog--idUser").getValue(),EmailId:sap.ui.getCore().byId("Secure_Dialog--idEmail").getValue()};if(a){var n=e.getSource().getBindingContext().sPath;this.ODataHelper.callOData(this.getOwnerComponent().getModel(),n,"PUT",{},i,this).then(function(e){sap.m.MessageToast.show("Server Updated successfully");t.getView().setBusy(false);t._oDialogSecure.close()}).catch(function(e){t.getView().setBusy(false);t.oPopover=t.getErrorMessage(e);t.getView().setBusy(false)})}else{var l={name:i.UserName,emailId:i.EmailId,password:o,role:i.Role,Authorization:"kREmIDG9mpGiGuWnfayajMIyIZhNEPfZ2okow0VLRMxyAs2dRZIH1L5eqTLYdEGY"};$.post("/createNewUser",l).then(function(e){t.getOwnerComponent().getModel().refresh();sap.m.MessageToast.show(e);t.getView().setBusy(false);t._oDialogSecure.close()}).fail(function(e){sap.m.MessageBox.error("User Creation failed");t.getView().setBusy(false);t.getView().setBusy(false)})}},onPressHandleSecureOkPopup1:function(e){var t=sap.ui.getCore().byId("idChangePass--idPassEmail").getValue();var a=sap.ui.getCore().byId("idChangePass--idCurrentPassword").getValue();var o=sap.ui.getCore().byId("idChangePass--idPassword").getValue();var r=sap.ui.getCore().byId("idChangePass--idConfirmPassword").getValue();if(o!==r){s.show("Password not Matched");sap.ui.getCore().byId("idChangePass--idPassword").setValueState("Error");sap.ui.getCore().byId("idChangePass--idConfirmPassword").setValueState("Error");sap.ui.getCore().byId("idChangePass--idConfirmPassword").setValueStateText("Password not matched");sap.ui.getCore().byId("idChangePass--idPassword").setValueStateText("Password not matched");return}var i={email:t,password:a};var n=this;$.post("/api/Users/login",i).done(function(e,t){var a=e.id;var r=e.userId;var i={password:o};var l=n;$.ajax("/api/Users/"+r+"?access_token="+a,{type:"PUT",contentType:"application/json",data:JSON.stringify(i),success:function(e,t,a){s.show("Password Updated Successfully");l._oDialogSecure1.close()},error:function(e,t,a){s.show("Password Update failed,Please contact Server");l._oDialogSecure1.close()}})}).fail(function(e,t,s){sap.ui.getCore().byId("idChangePass--idCurrentPassword").setValueState("Error");sap.m.MessageBox.error("Failed, Please enter correct credentials")})},_removeCreateMode:function(e){for(var t=0;t<e.length;t++){delete e[t].CreateMode}},_checkForSecureChangesButton:function(){var e=this.getView().getModel("local");var t=e.getData().appUsers;this._removeCreateMode(t)},onPressHandleSecureCancelPopup:function(){this._oDialogSecure.close();this._oDialogSecure.destroy();this._oDialogSecure=null},onPressHandleSecureCancelPopup1:function(){this._oDialogSecure1.close();this._oDialogSecure1.destroy();this._oDialogSecure1=null},onPressOpenAddSecureDialog:function(e){if(!this._oDialogSecure){this._oDialogSecure=sap.ui.xmlfragment("Secure_Dialog","victoria.fragments.SecureDialog",this);this.getView().addDependent(this._oDialogSecure);if(e==false){this._oDialogSecure.bindElement(this.aBindingContext);sap.ui.getCore().byId("Secure_Dialog--idPassword").setVisible(false);sap.ui.getCore().byId("Secure_Dialog--idConfirmPassword").setVisible(false)}else{this._oDialogSecure.unbindElement(this.aBindingContext);sap.ui.getCore().byId("Secure_Dialog--idPassword").setVisible(true);sap.ui.getCore().byId("Secure_Dialog--idConfirmPassword").setVisible(true)}}jQuery.sap.syncStyleClass("sapUiSizeCompact",this.getView(),this._oDialogSecure);this._oDialogSecure.open()},onPressOpenAddSecureDialog1:function(e){},onBack:function(){sap.ui.getCore().byId("idApp").to("idView1")},onSave:function(){console.log(this.getView().getModel("local").getProperty("/newBatch"))},onStartChange:function(e){var t=e.getSource().getValue();var s=t.split(".");var a=new Date(s[2],s[1]-1,s[0]);var o=this.formatter.getIncrementDate(a,2.5);this.getView().getModel("local").setProperty("/newBatch/endDate",o);var r=this.formatter.getIncrementDate(a,8);this.getView().getModel("local").setProperty("/newBatch/blogDate",r);console.log(o);console.log(r)},editSecureField:function(e){this.aBindingContext=e.getSource().getBindingContext().sPath;this.onPressOpenAddSecureDialog(false)},editSecureField1:function(e){this.aBindingContext=e.getSource().getBindingContext().sPath;if(!this._oDialogSecure1){this._oDialogSecure1=sap.ui.xmlfragment("idChangePass","victoria.fragments.SecurePassword",this);this.getView().addDependent(this._oDialogSecure1);this._oDialogSecure1.bindElement(this.aBindingContext)}this._oDialogSecure1.open()},_getSecureDetails:function(){var e=this},herculis:function(e){this.getView().getModel("local").setProperty("/newBatch/startDate",this.formatter.getFormattedDate(0));this.getView().getModel("local").setProperty("/newBatch/demoDate",this.formatter.getFormattedDate(0));this.getView().getModel("local").setProperty("/newBatch/endDate",this.formatter.getFormattedDate(2.5));this.getView().getModel("local").setProperty("/newBatch/blogDate",this.formatter.getFormattedDate(8));this._getSecureDetails()}})});