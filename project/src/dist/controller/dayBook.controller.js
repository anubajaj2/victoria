sap.ui.define(["victoria/controller/BaseController","sap/m/MessageBox","sap/m/MessageToast","sap/ui/model/Filter","sap/ui/export/library","sap/ui/export/Spreadsheet","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel"],function(e,t,i,a,r,o,s,n){"use strict";var l=r.EdmType;return e.extend("victoria.controller.dayBook",{onInit:function(){var t=this;t.getView().setBusy(false);e.prototype.onInit.apply(this);var i=this.getRouter();var t=this;var a=this.getModel("local").getProperty("/CurrentUser");var r=this.getModel("local").oData.AppUsers[a].UserName;r="Hey "+r;this.getView().byId("idUser").setText(r);i.getRoute("dayBook").attachMatched(this._onRouteMatched,this)},getRouter:function(){return sap.ui.core.UIComponent.getRouterFor(this)},_onRouteMatched:function(e){var t=this;var i=t.getModel("local").getProperty("/CurrentUser");if(t.getModel("local").oData.AppUsers[i].Role!=="Admin"){var r=new a([new sap.ui.model.Filter("CustomerCode",sap.ui.model.FilterOperator.EQ,"")],true);t.getView().byId("idTable1").getBinding("items").filter(r);t.getView().setBusy(false);var o=t.allMasterData.customers;var s=[];function n(e){return Object.keys(e).length}for(var l in o){var d=o[l].Group;var u=t.allMasterData.groups[d].hide;if(u===false){s.push(o[l])}}t.getView().getModel("local").setProperty("/finalCustomer",s)}else{function n(e){return Object.keys(e).length}var o=t.allMasterData.customers;var g=n(o);var c=[];for(var l in o){c.push(o[l])}t.getView().getModel("local").setProperty("/finalCustomer",c)}this.getView().getModel("local").setProperty("/Footer",false)},onValueHelpRequest:function(e){this.ODataHelper.callOData(this.getOwnerComponent().getModel(),"/Customers","GET",null,null,this).then(function(e){for(var i=0;i<e.results.length;i++){t.allMasterData.customers[e.results[i].id]=e.results[i];t.allMasterData.customersId[e.results[i].CustomerCode]=e.results[i]}}).catch(function(e){var i=t.getErrorMessage(e)});if(!this.searchPopup){var t=this;this.searchPopup=new sap.ui.xmlfragment("victoria.fragments.popup",this);this.getView().addDependent(this.searchPopup);var i=this.getView().getModel("i18n").getProperty("customer");this.searchPopup.setTitle(i);this.searchPopup.bindAggregation("items",{path:"local>/finalCustomer",template:new sap.m.DisplayListItem({label:"{local>CustomerCode}",value:{parts:[{path:"local>Name"},{path:"local>City"}],formatter:function(e,i){return e+"-"+t.allMasterData.cities[i].cityName}}}),sorter:new sap.ui.model.Sorter("CustomerCode")})}this.searchPopup.open()},onEnter:function(e){var t=this;var i=this.getView().byId("idCustDay").getValue();var a=this.getView().byId("idCustDay").getValue();if(i!==""){var r=this.allMasterData.customersId[a].id}var o=this.getModel("local").getProperty("/CurrentUser");if(this.getModel("local").oData.AppUsers[o].Role!=="Admin"){if(!i){}else{return}}else{this.getCustomer(e)}},_getSecureDetails:function(){var e=this},onPressEntryDownload:function(){var e=this.getView().byId("idCustDay").getValue();var t=this.getView().byId("dateRangeId").getDateValue();var i=this.getView().byId("dateRangeId").getSecondDateValue();var a=this.getView().getModel("local").getProperty("/EntryData");var r=null;var o=null;this.getView().getModel("local").getProperty("/EntryData",a);if(t===null&&i===null){window.open("/entryDownload?id="+a.Customer+"&type=DayBook&name="+o+"&city="+r+"&min="+t+"&max="+i)}else if(e===""){window.open("/entryDownloadDate?id="+e+"&type=DayBook&name="+o+"&city="+r+"&min="+t.toISOString()+"&max="+i.toISOString())}else{window.open("/entryDownloadBetween?id="+a.Customer+"&type=DayBook&name="+o+"&city="+r+"&min="+t.toISOString()+"&max="+i.toISOString())}},onBeforeExport:function(e){var t=e.getParameter("exportSettings");t.worker=false},onExportExcel:function(){var e=this;var t=this.getView().getModel().oData;this.JSONToExcelConvertor(t,"Report",true)},JSONToExcelConvertor:function(e,t,i){var a=typeof e.tableDetails!="object"?JSON.parse(e.tableDetails):e.tableDetails;var r="";if(i){var o="";o=o.slice(0,-1)}o+='"'+this.getView().byId("id1").getText()+'",';o+='"'+this.getView().byId("id2").getText()+'",';o+='"'+this.getView().byId("id3").getText()+'",';o+='"'+this.getView().byId("id4").getText()+'",';o+='"'+this.getView().byId("cashid").getText()+'",';o+='"'+this.getView().byId("id5").getText()+'",';o+='"'+this.getView().byId("id6").getText()+'",';o+='"'+this.getView().byId("id7").getText()+'",';r+=o+"\r\n";for(var s=0;s<a.length;s++){var o="";for(var n in a[s]){o+='"'+a[s][n]+'",'}o.slice(1,o.length);r+=o+"\r\n"}var l="";l+='"",';l+='"",';l+='"",';l+='"Total:'+this.getView().byId("totalPickedWtId").getText()+'",';l+='"",';l+='"Total:'+this.getView().byId("totalPickedVolId").getText()+'",';l+='"",';r+=l+"\r\n";if(r==""){alert("Invalid data");return}var d="MyReport_";d+=t.replace(/ /g,"_");var u="data:application/vnd.ms-excel:base64,"+encodeURIComponent(r);var g=document.createElement("a");g.href=u;g.style="visibility:hidden";g.download=d+".xls";document.body.appendChild(g);g.click();document.body.removeChild(g)},onConfirm:function(e){var t=e.getParameter("selectedItem").getLabel();this.getView().byId("idCustDay").setValue(t);this.getView().getModel("local").setProperty("/EntryData/Customer",e.getParameter("selectedItem").getBindingContextPath().split("'")[1])},onUpdateFinished:function(e){var t=e.getSource();var i=t.getItems();var a=i.length;var r=a<=20?0:a-20;var o;var s;console.log(a);var n=this.getView().getModel("i18n").getProperty("allEntries");this.getView().byId("idTitle").setText(n+" "+"("+a+")");this.getView().byId("idTable1").setBlocked(false);this.getView().byId("idTable1").setShowOverlay(false);for(var l=0;l<a;l++){var d=t.getItems()[l].getCells()[2].getText();var u=t.getItems()[l].getCells()[3].getText();var g=this.allMasterData.customers[d];var c=this.allMasterData.materials[u];t.getItems()[l].getCells()[1].setText(g.CustomerCode+" - "+g.Name);if(u!==""&&c!==undefined){t.getItems()[l].getCells()[3].setText(c.ProductCode+" - "+c.ProductName)}}},onFilterSearch:function(e){var t=this;var i=this.getView().byId("idCustDay").getValue();if(i!==""){var r=this.allMasterData.customersId[i].id}var o=this.getView().byId("dateRangeId").getDateValue();var s=this.getView().byId("dateRangeId").getSecondDateValue();var n=[];var l=new Date(s);if(o!==null&&s!==null){if(o.getTimezoneOffset()>0){o.setMinutes(o.getMinutes()+o.getTimezoneOffset())}else{o.setMinutes(o.getMinutes()-o.getTimezoneOffset())}if(s.getTimezoneOffset()>0){s.setMinutes(s.getMinutes()+s.getTimezoneOffset())}else{s.setMinutes(s.getMinutes()-s.getTimezoneOffset())}var d=new a([new sap.ui.model.Filter("Date",sap.ui.model.FilterOperator.BT,o,s)],true);n.push(d)}if(i!==""){var u=new sap.ui.model.Filter("Customer","EQ","'"+r+"'");n.push(u)}this.getView().byId("idTable1").getBinding("items").filter(n);if(o===null&&s===null){$.post("/getTotalEntryCustomer",{Customer:r}).then(function(e){t.getView().getModel("local").setProperty("/Footer",true);t.byId("idTC1").setText(parseFloat(e.CashTotal).toFixed(2));t.byId("idTC1").getText();parseFloat(t.byId("idTC1").getText());if(parseFloat(t.byId("idTC1").getText())>0){t.byId("idTC1").setState("Success")}else{t.byId("idTC1").setState("Warning")}t.getView().byId("idG1").setText(parseFloat(e.GoldTotal.toFixed(3)));t.byId("idG1").getText();parseFloat(t.byId("idG1").getText());if(parseFloat(t.byId("idG1").getText())>0){t.byId("idG1").setState("Success")}else{t.byId("idG1").setState("Warning")}t.getView().byId("idS1").setText(parseFloat(e.SilverTotal.toFixed(2)));t.byId("idS1").getText();parseFloat(t.byId("idS1").getText());parseFloat(t.byId("idS1").getText()).toFixed(3);if(parseFloat(parseFloat(t.byId("idS1").getText()).toFixed(3))>0){t.byId("idS1").setState("Success")}else{t.byId("idS1").setState("Warning")}})}else{if(i===""){var g=i}else{var g=r}o.setHours(0,0,0,0);$.post("/getTotalEntryCustomerBetween",{Customer:g,max:l,min:o}).then(function(e){t.getView().getModel("local").setProperty("/Footer",true);t.byId("idTC1").setText(parseFloat(e.CashTotal).toFixed(2));t.byId("idTC1").getText();parseFloat(t.byId("idTC1").getText());if(parseFloat(t.byId("idTC1").getText())>0){t.byId("idTC1").setState("Success")}else{t.byId("idTC1").setState("Warning")}t.getView().byId("idG1").setText(parseFloat(e.GoldTotal.toFixed(3)));t.byId("idG1").getText();parseFloat(t.byId("idG1").getText());if(parseFloat(t.byId("idG1").getText())>0){t.byId("idG1").setState("Success")}else{t.byId("idG1").setState("Warning")}t.getView().byId("idS1").setText(parseFloat(e.SilverTotal.toFixed(2)));t.byId("idS1").getText();parseFloat(t.byId("idS1").getText());parseFloat(t.byId("idS1").getText()).toFixed(3);if(parseFloat(parseFloat(t.byId("idS1").getText()).toFixed(3))>0){t.byId("idS1").setState("Success")}else{t.byId("idS1").setState("Warning")}})}},onFilterClear:function(e){this.getView().getModel("local").setProperty("/Footer",false);this.getView().byId("idTable1").getBinding("items").filter("/")},createColumnConfig:function(){var e=[];var t=[];e.push({label:"Date",property:["Date"],type:l.Date});e.push({property:["Name","CustomerCode"]});e.push({property:"Customer",type:l.String});e.push({property:"Product",type:l.String});e.push({property:"Cash",type:l.Number});e.push({property:"Gold",type:l.Number});e.push({property:"Silver",type:l.Number});e.push({property:"Remarks",type:l.String});t.push({property:"TA",type:l.Number});return e},onExport:function(){var e,t,i,a,r;if(!this._oTable){this._oTable=this.byId("idTable1")}r=this._oTable;t=r.getBinding("items");e=this.createColumnConfig();var s=t.getModel();i={workbook:{columns:e,hierarchyLevel:"Level"},dataSource:{type:"OData",dataUrl:t.getDownloadUrl?t.getDownloadUrl():null,serviceUrl:this._sServiceUrl,headers:s.getHeaders?s.getHeaders():null,count:t.getLength?t.getLength():null,useBatch:true},fileName:"Table export sample.xlsx",worker:false};a=new o(i);a.build().finally(function(){a.destroy()})},totalFormatter:function(e){return e.length},decimalvalidator1:function(e){if(e.mParameters.id==="__component0---idEntry--idCash"){$(function(){$("input").on("input.idCash",function(e){if(e.currentTarget.id=="__component0---idEntry--idCash-inner"){this.value=this.value.match(/^[+-]?\d{0,8}(\.\d{0,2})?/)[0]}})})}},decimalvalidator2:function(e){if(e.mParameters.id==="__component0---idEntry--idGold"){$(function(){$("input").on("input.idGold",function(e){if(e.currentTarget.id=="__component0---idEntry--idGold-inner"){this.value=this.value.match(/^[+-]?\d{0,6}(\.\d{0,3})?/)[0]}})})}},decimalvalidator3:function(e){if(e.mParameters.id==="__component0---idEntry--idSilver"){$(function(){$("input").on("input.idSilver",function(e){if(e.currentTarget.id=="__component0---idEntry--idSilver-inner"){this.value=this.value.match(/^[+-]?\d{0,5}(\.\d{0,2})?/)[0]}})})}},decimalvalidator4:function(e){if(e.mParameters.id==="__component0---idEntry--idweight"){$(function(){$("input").on("input.idweight",function(e){if(e.currentTarget.id=="__component0---idEntry--idweight-inner"){this.value=this.value.match(/^[+-]?\d{0,5}(\.\d{0,3})?/)[0]}})})}},decimalvalidator5:function(e){if(e.mParameters.id==="__component0---idEntry--idtunch"){$(function(){$("input").on("input.idtunch",function(e){if(e.currentTarget.id=="__component0---idEntry--idtunch-inner"){this.value=this.value.match(/^[+-]?\d{0,5}(\.\d{0,3})?/)[0]}})})}},onMaterialSelect:function(e){var t=e.getParameter("selectedItem").getModel().getProperty(e.getParameter("selectedItem").getBindingContext().getPath());var i=e.getParameter("selectedItem").getText();var a=e.getParameter("selectedItem").getAdditionalText();var r=e.getParameter("selectedItem").getKey();this.getView().byId("idMat").setValue(i);this.getView().byId("idMatText").setText(a+" - "+r)},onRemarksSubmit:function(e){this.getView().byId("sendButton").focus()},onSubmit:function(e){var t=this;var a=this.getView().byId("idCustDay").getValue();var r=t.allMasterData.customers;var o=[];function s(e){return Object.keys(e).length}var n="N";for(var l in r){var d=r[l].Group;var u=t.allMasterData.groups[d].hide;var g=r[l].CustomerCode;if(a===g){n="Y";break}}if(n==="N"){i.show("This is Hide Data");return}$(function(){$("input:text:first").focus();var e=$("input:text");e.bind("keypress",function(t){var i=t.which;if(i==13){t.preventDefault();var a=e.index(this)+1;$(":input:text:eq("+a+")").focus()}})})},onCashSubmit:function(e){this.getView().byId("idGold").focus()},onGoldSubmit:function(e){this.getView().byId("idSilver").focus()},onSilverSubmit:function(e){this.getView().byId("idRemarks").focus()},onRemarksSubmit:function(e){this.getView().byId("sendButton").focus()},onSubmitSideWeight:function(e){this.getView().byId("idtunch").focus()},onSubmitSideTunch:function(e){this.getView().byId("calculateButton").focus()},onSelect:function(e){jQuery.sap.delayedCall(500,this,function(){})},inpField:"",onSelectValue:function(e){var t=e.getParameter("selectedItem");var i=t.getLabel();sap.ui.getCore().byId(this.inpField).setValue(i);var a=this;this.getView().byId("idCustDay").setValue(i)},onSuggest:function(e){const t=e.key;var i=e.getParameter("id").split("--")[2];var a=e.getParameter("suggestValue");if(a===""||t==8||t==="Backspace"||t==="Delete"){this.getView().byId("idCustDay").setValue("");return}if(!a){a=e.getParameter("newValue")}if(a){var r=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("CustomerCode",sap.ui.model.FilterOperator.Contains,a.toUpperCase()),new sap.ui.model.Filter("Name",sap.ui.model.FilterOperator.Contains,a.toUpperCase())],and:false})}e.getSource().getBinding("suggestionItems").filter(r);var o=new sap.ui.model.Sorter({path:"CustomerCode",descending:false});e.getSource().getBinding("suggestionItems").sort(o);this.getView().byId("idCustDay").setValue(a)}})});